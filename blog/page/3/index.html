<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Blog | 老司机的文档集</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://itxx00.github.io/notes/blog/page/3"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 老司机的文档集"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://itxx00.github.io/notes/blog/page/3"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/3" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/3" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/notes/blog/rss.xml" title="老司机的文档集 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes/blog/atom.xml" title="老司机的文档集 Atom Feed"><link rel="stylesheet" href="/notes/assets/css/styles.381e2749.css">
<link rel="preload" href="/notes/assets/js/runtime~main.19061fe9.js" as="script">
<link rel="preload" href="/notes/assets/js/main.7e231f6a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><div class="navbar__logo"><img src="https://github.com/itxx00.png" alt="老司机" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://github.com/itxx00.png" alt="老司机" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">老司机</b></a><a class="navbar__item navbar__link" href="/notes/docs/intro">教程</a><a class="navbar__item navbar__link" href="/notes/blog/archive/">历史博文</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/itxx00/notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/12/28/influxdb-ql-use-case">influxQL常用语句整理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/11/08/static-build-jq-fio">mac上使用docker交叉静态编译jq和fio</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/04/20/pre-commit-basic">pre-commit basic usage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/04/20/pxe-cobbler-install">使用cobbler批量安装centos系统</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2021/12/16/cvm-kylin-v10-iso-install">CVM使用ISO镜像安装银河麒麟v10 arm系统</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2017/08/20/hadoop3-ec-test">HADOOP3.0.0纠删码测试</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-08-20T00:00:00.000Z" itemprop="datePublished">2017年8月20日</time> · <!-- -->阅读需 6 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>记录hadoop3.0.0版本测试安装过程，对hadoop3.0.0中纠删码进行了简单测试。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础环境">基础环境<a class="hash-link" href="#基础环境" title="标题的直接链接">​</a></h2><p>HADOOP3.0.0版本中增加了纠删码技术，在提高可用性的同时还能减低存储成本，目前处于实验阶段，以下将测试环境中的搭建步骤及简单测试过程进行记录。本次仅对hdfs进行测试，因此不会部署其他服务。</p><p>系统环境如下：</p><p>kvm虚拟机，1个namenode节点，6个datanode节点，4core ，8G mem ， 50G disk</p><p>hadoop版本：3.0.0-alpha4</p><p>java版本： 1.8.0_144</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试集群安装">测试集群安装<a class="hash-link" href="#测试集群安装" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础包安装">基础包安装<a class="hash-link" href="#基础包安装" title="标题的直接链接">​</a></h3><p>从apache镜像下载hadoop-3.0.0-alpha4，当前最新版本，hadoop home目录/opt/hadoop，在namenode节点将配置等修改好之后拷贝到所有datanode节点。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf hadoop-3.0.0-alpha4.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> hadoop-3.0.0-alpha4 /opt/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> jdk --disablerepo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">* --enablerepo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">local-custom</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件修改">配置文件修改<a class="hash-link" href="#配置文件修改" title="标题的直接链接">​</a></h3><p>需要修改的配置文件有hadoop-env.sh 、core-site.xml、hdfs-site.xml</p><p>修改<code>/opt/hadoop/etc/hadoop/hadoop-env.sh</code>中以下参数：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">JAVA_HOME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/java/jdk1.8.0_144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HADOOP_HOME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 注意这里配置heapsize和2.7版本的差别，2.7为HADOOP_HEAPSIZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HADOOP_HEAPSIZE_MAX</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HADOOP_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$HADOOP_OPTS</span><span class="token string" style="color:#e3116c"> -Djava.net.preferIPv4Stack=true”</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">export HADOOP_CLIENT_OPTS=&quot;</span><span class="token plain">-Xmx512m </span><span class="token variable" style="color:#36acaa">$HADOOP_CLIENT_OPTS</span><span class="token plain">”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HADOOP_LOG_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${HADOOP_HOME}</span><span class="token plain">/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HADOOP_PID_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改<code>/opt/hadoop/etc/hadoop/hdfs-site.xml</code>内容如下：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.blocksize</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">134217728</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.datanode.data.dir</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">/data/hdfs/data</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.name.dir</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">/data/hdfs/namenode</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.rpc-address</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">192.168.199.26:8020</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将环境变量增加到当前用户bashrc：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ~/.bashrc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HADOOP_HOME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$PATH</span><span class="token plain">:/opt/hadoop/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置修改完成后将/opt/hadoop整个目录同步到所有datanode节点。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动hdfs">启动HDFS<a class="hash-link" href="#启动hdfs" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="格式化namenode">格式化namenode<a class="hash-link" href="#格式化namenode" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdfs namenode -format ns1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动namenode和datanode">启动namenode和datanode<a class="hash-link" href="#启动namenode和datanode" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 注意3.0.0版本的差别，在2.7中启动脚本如下</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hadoop-daemon.sh --config </span><span class="token variable" style="color:#36acaa">$HADOOP_HOME</span><span class="token plain">/etc/hadoop --script hdfs start namenode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hadoop-daemon.sh --config </span><span class="token variable" style="color:#36acaa">$HADOOP_HOME</span><span class="token plain">/etc/hadoop --script hdfs start datanode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 新版本中已经重写了管理脚本，统一到hdfs命令中，启动方式如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs --daemon start namenode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs --daemon start datanode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动成功之后即可通过<a href="http://192.168.199.26:9870/dfshealth.html#tab-datanode" target="_blank" rel="noopener noreferrer">namenode web ui</a>观察到集群基本情况，2.7中默认web ui端口为50070，而3.0.0中修改为9870，</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试hdfs">测试hdfs<a class="hash-link" href="#测试hdfs" title="标题的直接链接">​</a></h2><p>启动完成之后可以通过hdfs命令测试服务是否可用：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdfs dfs -mkdir hdfs://192.168.199.26:8020/t1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dd</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">if</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/dev/urandom </span><span class="token assign-left variable" style="color:#36acaa">of</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">f1 </span><span class="token assign-left variable" style="color:#36acaa">bs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">1M </span><span class="token assign-left variable" style="color:#36acaa">count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs dfs -put f1 hdfs://192.168.199.26:8020/t1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs dfs -rm -skipTrash hdfs://192.168.199.26:8020/t1/f1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里使用的时候需要写完整的hdfs协议和namenode:port，我们可以修改一下配置文件，将defaultfs修改为hdfs协议，方便测试。同时此版本中默认并未启用纠删码，需要手工配置。
默认内置支持的policy有 RS-3-2-64k, RS-6-3-64k, RS-10-4-64k, RS-LEGACY-6-3-64k, XOR-2-1-64k，我这里只准备了少量节点，因此只对其中两种进行简单测试。</p><p>修改<code>hdfs-site.xml</code> 增加以下配置：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.ec.policies.enabled</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">XOR-2-1-64k,RS-3-2-64k</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.nameservices</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.ha.namenodes.ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">nn1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.rpc-address.ns1.nn1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">192.168.199.26:8020</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.client.failover.proxy.provider.ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改<code>core-site.xml</code>增加以下配置：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">fs.defaultFS</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">hdfs://ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重启namenode节点后，就可以使用纠删码了，纠删码可以针对目录进行设置，不同的目录设置不同的策略。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdfs ec -setPolicy -policy XOR-2-1-64k -path /t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs ec -setPolicy -policy RS-3-2-64k -path /t2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们准备了3个目录，t1和t2分别设置了不同的policy，t3不设置，往3个目录上传相同的5G大小的文件，每次上传前均清空hdfs中数据，并清空虚拟机和物理机缓存，统计的耗时和空间占用情况大致如下：</p><table><thead><tr><th>HDFS目录</th><th>纠删码策略</th><th>put耗时</th><th>磁盘占用kb</th></tr></thead><tbody><tr><td>t1</td><td>XOR-2-1-64k</td><td>1m15.559s</td><td>7740364</td></tr><tr><td>t2</td><td>RS-3-2-64k</td><td>1m13.920s</td><td>8600436</td></tr><tr><td>t3</td><td>无(三副本)</td><td>2m7.705s</td><td>15480600</td></tr></tbody></table><p>通过简单的测试对比，我们可以大致了解到在理想状态下纠删码技术比传统的三副本在写入速度上有提升，因其降低了对磁盘IO和带宽的消耗，同时占用的磁盘空间小于三副本方式。其中磁盘占用和不同的纠删码策略理论值基本吻合， 磁盘空间消耗倍数为 <code>(校验块+数据块)/数据块</code>。</p><p>注意这里的测试仅限于对HADOOP3.0.0中纠删码有一个感性认识，测试方法有很多不严谨的地方，比如put数据的耗时并未考虑各种环境因素，仅仅是在一个相对理想的环境下进行简单测试。实际生产环境中情况非常复杂，需要权衡CPU带宽磁盘，甚至机架供电等各方面因素，如果需要获得一份可靠的性能对比数据则必须保障稳定运行足够长的时间，通过长期观察才能得出对生产有实际指导意义的信息。</p><p>参考文档：</p><p>[1]<!-- --> <a href="http://hadoop.apache.org/docs/r3.0.0-alpha4/hadoop-project-dist/hadoop-common/ClusterSetup.html" target="_blank" rel="noopener noreferrer">http://hadoop.apache.org/docs/r3.0.0-alpha4/hadoop-project-dist/hadoop-common/ClusterSetup.html</a></p><p>[2]<!-- --> <a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html" target="_blank" rel="noopener noreferrer">http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/hadoop">hadoop</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bigdata">bigdata</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2017/08/18/deploy-k8s-from-local-repo">k8s测试环境部署记录</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-08-18T00:00:00.000Z" itemprop="datePublished">2017年8月18日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>本文记录了在本地部署k8s测试环境的过程，部署脚本参考github上其他同学分享的脚本，在其基础上做了些小改动。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-中的节点类型">k8s 中的节点类型<a class="hash-link" href="#k8s-中的节点类型" title="标题的直接链接">​</a></h2><p>master 负责管理其他节点的调度中心，master可以有备机replica做冗余</p><p>minion 由master管理，运行容器服务，1个集群中有N个minion节点</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署前准备">部署前准备<a class="hash-link" href="#部署前准备" title="标题的直接链接">​</a></h2><p>部署此测试环境参考了github上其他同学的分享，我fork的repo地址：<a href="https://github.com/5xops/k8s-deploy" target="_blank" rel="noopener noreferrer">https://github.com/5xops/k8s-deploy</a></p><p>首先按照github repo中的readme部分将k8s rpm包下载到本地，以准备离线部署。其次我在本地测试环境准备了6以上的虚拟机节点，其中3个节点用于部署etcd集群，2个节点用于部署k8s master，其余节点用于部署k8s minion。
所有虚拟机均运行在一台物理服务器上，管理虚拟机用了这个脚本（<a href="https://github.com/itxx00/vmm%EF%BC%89%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/itxx00/vmm）。</a></p><p>首先创建好需要使用到的虚拟机节点：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vmm create etcd1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create etcd2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create kubem1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create kubem2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create node2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因部署k8s集群时要求所有节点都配置好主机名，因为默认创建出来的虚拟机没有修改hostname，需要使用另外一个脚本来配置hostname并配置好/etc/hosts，首先准备好初始化执行的脚本：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># content of ~/.vmm/init.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnm=$(cat hostname)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[ -n $hostnm ]] || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;err&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $hostnm &gt;/etc/hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostname $hostnm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /tmp/hosts.tmp &gt;/etc/hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着执行初始化操作：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vminit etcd1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit etcd2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit kubem1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit kubem2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit node2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>每个节点的hostname将被设置成虚拟机的名字，同时vminit脚本会把本地的ssh公钥和私钥都拷贝到虚拟机节点，这样初始化之后的节点可以通过相同的密钥互相免密登录，注意这样的操作仅适用于快速搭建测试环境，生产环境千万不要这么处理。打通免密ssh是因为后面部署k8s时会用到。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="搭建etcd集群">搭建etcd集群<a class="hash-link" href="#搭建etcd集群" title="标题的直接链接">​</a></h2><p>在部署k8s集群之前，我们需要先部署一个独立的etcd集群，k8s会用到这个集群。这里我采用ansible playbook来部署，playbook已经分享到github上面，（<a href="https://github.com/itxx00/ansible-etcd%EF%BC%89%EF%BC%8C%E6%8C%89%E7%85%A7repo%E4%B8%AD%E7%9A%84readme%E6%9D%A5%E5%87%86%E5%A4%87%E5%A5%BD%E9%9B%86%E7%BE%A4%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/itxx00/ansible-etcd），按照repo中的readme来准备好集群。</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备镜像仓库">准备镜像仓库<a class="hash-link" href="#准备镜像仓库" title="标题的直接链接">​</a></h2><p>将下载下来的k8s rpm包和docker镜像放到/data/k8s-deploy目录，其中rpms目录存放了需要用到的rpm包，images目录存放需要用到的docker镜像，因原脚本中不包含k8s dashboard（一套web ui管理界面），为了能够部署dashboard，对原脚本作了修改增加了部署dashboard的选项，部署dashboard需要一些额外的docker镜像和配置文件，这里先补充好docker镜像：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/kubernetes-dashboard-amd64:v1.6.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/heapster-influxdb-amd64:v1.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/heapster-grafana-amd64:v4.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/heapster-amd64:v1.3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /data/k8s-deploly/images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/kubernetes-dashboard-amd64 -o kubernetes-dashboard-amd64_v1.6.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/heapster-influxdb-amd64 -o heapster-influxdb-amd64_v1.1.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/heapster-grafana-amd64 -o heapster-grafana-amd64_v4.0.2.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/heapster-amd64 -o heapster-amd64_v1.3.0.tar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>原脚本中安装rpm包是在各节点下载好后本地安装的，我改进了一下采用yum方式安装，准备yum仓库：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">createrepo /data/k8s-deploy/rpms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;/etc/nginx/conf.d/k8srepo.conf &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       8000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name  _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root         /data/k8s-deploy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autoindex on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此yum repo和docker镜像准备完成。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署k8s集群">部署k8s集群<a class="hash-link" href="#部署k8s集群" title="标题的直接链接">​</a></h2><p>部署过程参考<a href="https://github.com/5xops/k8s-deploy/blob/master/README.md" target="_blank" rel="noopener noreferrer">https://github.com/5xops/k8s-deploy/blob/master/README.md</a> ，需要修改repo中的k8slocal.repo文件中ip地址为yum仓库对应的ip地址，部署master、minion和replica可参考master.sh，minon.sh, replica.sh的内容。
需要注意的是为了部署dashboard服务我们额外增加了dashboard相关的配置文件，具体增加的内容请参考这个commit： <a href="https://github.com/5xops/k8s-deploy/commit/1766a675d76edb32f310acd98d5c6ed50a356e5b" target="_blank" rel="noopener noreferrer">https://github.com/5xops/k8s-deploy/commit/1766a675d76edb32f310acd98d5c6ed50a356e5b</a></p><p>至此，k8s测试环境及搭建完成，后续我将使用这个k8s测试环境来部署其他服务，后面会慢慢分享。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/k-8-s">k8s</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/kubernetes">kubernetes</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2017/06/13/nftables-man-page">nftables：nft man文档阅读笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-06-13T00:00:00.000Z" itemprop="datePublished">2017年6月13日</time> · <!-- -->阅读需 48 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>利用空闲时间学习了nftables的基础知识，其中官方的man page中包含了大量信息，在阅读过程中整理了一份带中文注释的笔记，以辅助加深记忆。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具名称">工具名称<a class="hash-link" href="#工具名称" title="标题的直接链接">​</a></h2><p>nft --  包过滤规则管理工具</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基本用法">基本用法<a class="hash-link" href="#基本用法" title="标题的直接链接">​</a></h2><p><code>nft [ -n | --numeric ] [ -s | --stateless ] [ [-I | --includepath] directory ] [ [-f | --file] filename | [-i | --interactive] | cmd ]</code></p><p><code>nft [ -h | --help ] [ -v | --version ]</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具描述">工具描述<a class="hash-link" href="#工具描述" title="标题的直接链接">​</a></h2><p>nftables 作为新一代的防火墙策略框架，旨在替代之前的各种防火墙工具诸如iptables/ebtables等，而且提供了类似tc的带宽限速能力。而nft则提供了nftables的命令行入口，是用户空间的管理工具。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="选项说明">选项说明<a class="hash-link" href="#选项说明" title="标题的直接链接">​</a></h2><p>执行<code>nft --help</code>查看完整帮助信息</p><p><code>-h, --help</code></p><dd><p>查看帮助信息.</p></dd><p><code>-v, --version</code></p><dd><p>查看版本号.</p></dd><p><code>-n, --numeric</code></p><dd><p>以数值方式展示数据，可重复使用，一个-n表示不解析域名，第二次不解析端口号，第三次不解析协议和uid/gid。</p></dd><p><code>-s, --stateless</code></p><dd><p>省略规则和有状态对象的状态信息</p></dd><p><code>-N</code></p><dd><p>将ip地址解析成域名，依赖dns解析。</p></dd><p><code>-a, --handle</code></p><dd><p>输出内容中展示规则handle信息</p></dd><p><code>-I, --includepath directory</code></p><dd><p>添加include文件搜索目录</p></dd><p><code>-f, --file filename</code></p><dd><p>从文件获取输入</p></dd><p><code>-i, --interactive</code></p><dd><p>从交互式cli获取输入</p></dd><h2 class="anchor anchorWithStickyNavbar_LWe7" id="文件格式">文件格式<a class="hash-link" href="#文件格式" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="语法规定">语法规定<a class="hash-link" href="#语法规定" title="标题的直接链接">​</a></h3><p>单行过长可用<code>\</code>换行连接；
多个命令写到同一行可用分号<code>;</code> 分隔；
注释使用井号<code>#</code>打头；
标识符用大小写字母打头，后面跟数字字母下划线正斜杠反斜杠以及点号;
用双引号引起来表示纯字符串。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件引用">文件引用<a class="hash-link" href="#文件引用" title="标题的直接链接">​</a></h3><p><code>include &quot;filename&quot;</code></p><p>可由外部文件通过<code>include</code>导入到当前文件，用<code>-I/--includepath</code>指定导入文件所在目录，如果include后面接的是目录而非文件，则整个目录的文件将以字母顺序依次导入。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="符号变量">符号变量<a class="hash-link" href="#符号变量" title="标题的直接链接">​</a></h3><p><code>define variable = expr</code></p><p><code>$variable</code></p><p>Symbolic variables can be defined using the <strong><em>define</em></strong> statement. Variable references are expressions and can be used initialize other variables. The scope of a definition is the current block and all blocks contained within.
变量使用<code>define</code>定义，变量引用属于表达式，可以用于初始化其他变量，变量的生效范围在当前block以及被包含的所有block内。</p><p><strong><em>示例 1. 使用符号变量</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">define int_if1 = eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">define int_if2 = eth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">define int_ifs = { $int_if1, $int_if2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iif $int_ifs accept</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="地址族">地址族<a class="hash-link" href="#地址族" title="标题的直接链接">​</a></h2><p>根据处理的包的种类不同可以将其分为不同的地址族。不同的地址族在内核中包含有特定阶段的处理路径和hook点，当对应hook的规则存在时则会被nftables处理。具体类型如下：</p><p><code>ip</code></p><dd><p>IPv4 地址族</p></dd><p><code>ip6</code></p><dd><p>IPv6 地址族</p></dd><p><code>inet</code></p><dd><p>Internet (IPv4/IPv6) 地址族</p></dd><p><code>arp</code></p><dd><p>ARP 地址族</p></dd><p><code>bridge</code></p><dd><p>Bridge 地址族</p></dd><p><code>netdev</code></p><dd><p>Netdev 地址族</p></dd><p>所有nftables对象存在于特定的地址族namespace中，换言之所有identifier都含有一个特定的地址族，如果未指定则默认使用<code>ip</code>地址族</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4ipv6inet-address-families">IPv4/IPv6/Inet address families<a class="hash-link" href="#ipv4ipv6inet-address-families" title="标题的直接链接">​</a></h3><p>IPv4/IPv6/Inet 地址族用于处理 IPv4和IPv6包，其在network stack中在不同的包处理阶段一共包含了5个hook.</p><p><strong><em>Table 1. IPv4/IPv6/Inet 地址类hook列表</em></strong></p><table><thead><tr><th>Hook名称</th><th>描述</th></tr></thead><tbody><tr><td>prerouting</td><td>所有进入到系统的包都会被prerouting hook进行处理. 它在routing流程之前就被发起，用于靠前阶段的包过滤或者更改影响routing的包属性.</td></tr><tr><td>input</td><td>发往本地系统的包将被input hook处理.</td></tr><tr><td>forward</td><td>被转发到其他主机的包会经由forward hook处理.</td></tr><tr><td>output</td><td>由本地进程发送出去的包将被output hook处理.</td></tr><tr><td>postrouting</td><td>所有离开系统的包都将被postrouting hook处理.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="arp-address-family">ARP address family<a class="hash-link" href="#arp-address-family" title="标题的直接链接">​</a></h3><p>ARP地址族用于处理经由系统接收和发送的ARP包。一般在集群环境中对ARP包进行mangle处理以支持clustering。</p><p><strong><em>Table 2. ARP address family hooks</em></strong></p><table><thead><tr><th>Hook</th><th>描述</th></tr></thead><tbody><tr><td>input</td><td>分发到本机的包会经过input hook.</td></tr><tr><td>output</td><td>由本机发出的包会经过output hook.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bridge-address-family">Bridge address family<a class="hash-link" href="#bridge-address-family" title="标题的直接链接">​</a></h3><p>bridge地址族处理通过桥接设备的ethernet包。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="netdev-address-family">Netdev address family<a class="hash-link" href="#netdev-address-family" title="标题的直接链接">​</a></h3><p>Netdev地址族处理从ingress过来的包。</p><p><strong><em>Table 3. Netdev address family hooks</em></strong></p><table><thead><tr><th>Hook</th><th>Description</th></tr></thead><tbody><tr><td>ingress</td><td>所有进入系统的包都将被ingress hook处理。它在进入layer 3之前的阶段就开始处理。</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tables">Tables<a class="hash-link" href="#tables" title="标题的直接链接">​</a></h2><p><code>{add | delete | list | flush} table [family] {table}</code></p><p>table是chain/set/stateful object的容器，table由其地址族和名字做标识。地址族必须属于ip, ip6, arp, bridge, netdev中的一种，inet地址族是一个虚拟地址族，同来创建同时包含IPv4和IPv6的table，如果没有指定地址族则默认使用<code>ip</code>地址族。</p><p><code>add</code></p><dd><p>添加指定地址族，指定名称的table</p></dd><p><code>delete</code></p><dd><p>删除指定的table</p></dd><p><code>list</code></p><dd><p>列出指定table中的所有chain和rule</p></dd><p><code>flush</code></p><dd><p>清除指定table中的所有chain和rule</p></dd><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chains">Chains<a class="hash-link" href="#chains" title="标题的直接链接">​</a></h2><p><code>{add} chain [family] {table} {chain} {hook} {priority} {policy} {device}</code></p><p><code>{add | create | delete | list | flush} chain [family] {table} {chain}</code></p><p><code>{rename} chain [family] {table} {chain} {newname}</code></p><p>chain是rule的容器，他们存在于两种类型，基础链（base chain）和常规链（regular chain）。base chain是网络栈中数据包的入口点，regular chain则可用于jump的目标并对规则进行更好地组织。</p><p><code>add</code></p><dd><p>在指定table中添加新的链，当hook和权重值被指定时，添加的chain为base chain，将在网络栈中hook相关联。</p></dd><p><code>create</code></p><dd><p>与<code>add</code>命令类似，不同之处在于当创建的chain存在时会返回错误。</p></dd><p><code>delete</code></p><dd><p>删除指定的chain，被删除的chain不能有规则且不能是跳转目标chain。</p></dd><p><code>rename</code></p><dd><p>重命名chain</p></dd><p><code>list</code></p><dd><p>列出指定chain中的所有rule</p></dd><p><code>flush</code></p><dd><p>清除指定chain中所有rule</p></dd><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rules">Rules<a class="hash-link" href="#rules" title="标题的直接链接">​</a></h2><p><code>[add | insert] rule [family] {table} {chain} [position position] {statement...}</code></p><p><code>{delete} rule [family] {table} {chain} {handle handle}</code></p><p>Rules are constructed from two kinds of components according to a set of grammatical rules: expressions and statements.</p><p><code>add</code></p><dd><p>Add a new rule described by the list of statements. The rule is appended to the given chain unless a position is specified, in which case the rule is appended to the rule given by the position.</p></dd><p><code>insert</code></p><dd><p>Similar to the <strong><em>add</em></strong> command, but the rule is prepended to the beginning of the chain or before the rule at the given position.</p></dd><p><code>delete</code></p><dd><p>Delete the specified rule.</p></dd><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sets">Sets<a class="hash-link" href="#sets" title="标题的直接链接">​</a></h2><p><code>{add} set family] {table} {set}{ {type} [flags] [timeout] [gc-interval] [elements] [size] [policy]}</code></p><p><code>{delete | list | flush} set [family] {table} {set}</code></p><p><code>{add | delete} element [family] {table} {set}{ {elements}}</code></p><p>Sets are elements containers of an user-defined data type, they are uniquely identified by an user-defined name and attached to tables.
sets 是用户定义的数据类型的容器，具有用户定义的唯一标识，被应用到table上。</p><p><code>add</code></p><dd><p>在指定的table中添加一个新的set</p></dd><p><code>delete</code></p><dd><p>删除指定set</p></dd><p><code>list</code></p><dd><p>查看set内的元素</p></dd><p><code>flush</code></p><dd><p>清空整个set</p></dd><p><code>add element</code></p><dd><p>往set中添加元素，多个使用逗号分隔</p></dd><p><code>delete element</code></p><dd><p>从set中删除元素，多个使用逗号分隔</p></dd><p><strong><em>Table 4. Set 参数</em></strong></p><table><thead><tr><th>关键字</th><th>描述</th><th>类型</th></tr></thead><tbody><tr><td>type</td><td>元素的数据类型</td><td>string: ipv4_addr, ipv6_addr, ether_addr, inet_proto, inet_service, mark</td></tr><tr><td>flags</td><td>set flags</td><td>string: constant, interval, timeout</td></tr><tr><td>timeout</td><td>元素在set中的存活时间</td><td>string, 带单位的小数. 单位: d, h, m, s</td></tr><tr><td>gc-interval</td><td>垃圾回收间隔, 仅当timeout或flag timeout设置时生效</td><td>string, decimal followed by unit. Units are: d, h, m, s</td></tr><tr><td>elements</td><td>set中包含的元素</td><td>set data type</td></tr><tr><td>size</td><td>set可存放的最大元素个数</td><td>unsigned integer (64 bit)</td></tr><tr><td>policy</td><td>set policy</td><td>string: performance <!-- -->[default]<!-- -->, memory</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="maps">Maps<a class="hash-link" href="#maps" title="标题的直接链接">​</a></h2><p><code>{add} map [family] {table} {map}{ {type} [flags] [elements] [size] [policy]}</code></p><p><code>{delete | list | flush} map [family] {table} {map}</code></p><p><code>{add | delete} element [family] {table} {map}{ {elements}}</code></p><p>Maps store data based on some specific key used as input, they are uniquely identified by an user-defined name and attached to tables.</p><p><code>add</code></p><dd><p>Add a new map in the specified table.</p></dd><p><code>delete</code></p><dd><p>Delete the specified map.</p></dd><p><code>list</code></p><dd><p>Display the elements in the specified map.</p></dd><p><code>flush</code></p><dd><p>Remove all elements from the specified map.</p></dd><p><code>add element</code></p><dd><p>Comma-separated list of elements to add into the specified map.</p></dd><p><code>delete element</code></p><dd><p>Comma-separated list of element keys to delete from the specified map.</p></dd><p><strong><em>Table 5. Map specifications</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>data type of map elements</td><td>string &#x27;:&#x27; string: ipv4_addr, ipv6_addr, ether_addr, inet_proto, inet_service, mark, counter, quota. Counter and quota can&#x27;t be used as keys</td></tr><tr><td>flags</td><td>map flags</td><td>string: constant, interval</td></tr><tr><td>elements</td><td>elements contained by the map</td><td>map data type</td></tr><tr><td>size</td><td>maximun number of elements in the map</td><td>unsigned integer (64 bit)</td></tr><tr><td>policy</td><td>map policy</td><td>string: performance <!-- -->[default]<!-- -->, memory</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stateful-objects">Stateful objects<a class="hash-link" href="#stateful-objects" title="标题的直接链接">​</a></h2><p><code>{add | delete | list | reset} type [family] {table} {object}</code></p><p>Stateful objects are attached to tables and are identified by an unique name. They group stateful information from rules, to reference them in rules the keywords &quot;type name&quot; are used e.g. &quot;counter name&quot;.</p><p><code>add</code></p><dd><p>Add a new stateful object in the specified table.</p></dd><p><code>delete</code></p><dd><p>Delete the specified object.</p></dd><p><code>list</code></p><dd><p>Display stateful information the object holds.</p></dd><p><code>reset</code></p><dd><p>List-and-reset stateful object.</p></dd><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ct">Ct<a class="hash-link" href="#ct" title="标题的直接链接">​</a></h3><p><strong><em>ct</em></strong> {helper} {type} {type} {protocol} {protocol} <!-- -->[l3proto][family]</p><p>Ct helper is used to define connection tracking helpers that can then be used in combination with the &quot;ct helper set&quot; statement. type and protocol are mandatory, l3proto is derived from the table family by default, i.e. in the inet table the kernel will try to load both the ipv4 and ipv6 helper backends, if they are supported by the kernel.</p><p><strong><em>Table 6. conntrack helper specifications</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>name of helper type</td><td>quoted string (e.g. &quot;ftp&quot;)</td></tr><tr><td>protocol</td><td>layer 4 protocol of the helper</td><td>string (e.g. tcp)</td></tr><tr><td>l3proto</td><td>layer 3 protocol of the helper</td><td>address family (e.g. ip)</td></tr></tbody></table><p><strong><em>示例 2. defining and assigning ftp helper</em></strong></p><p>Unlike iptables, helper assignment needs to be performed after the conntrack lookup has completed, for example with the default 0 hook priority.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table inet myhelpers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ct helper ftp-standard {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     type &quot;ftp&quot; protocol tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chain prerouting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type filter hook prerouting priority 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tcp dport 21 ct helper set &quot;ftp-standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="counter">Counter<a class="hash-link" href="#counter" title="标题的直接链接">​</a></h3><p><strong><em>counter</em></strong> <!-- -->[packets bytes]</p><p><strong><em>Table 7. Counter specifications</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>packets</td><td>initial count of packets</td><td>unsigned integer (64 bit)</td></tr><tr><td>bytes</td><td>initial count of bytes</td><td>unsigned integer (64 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="quota">Quota<a class="hash-link" href="#quota" title="标题的直接链接">​</a></h3><p><strong><em>quota</em></strong> <!-- -->[over | until][used]</p><p><strong><em>Table 8. Quota specifications</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>quota</td><td>quota limit, used as the quota name</td><td>Two arguments, unsigned interger (64 bit) and string: bytes, kbytes, mbytes. &quot;over&quot; and &quot;until&quot; go before these arguments</td></tr><tr><td>used</td><td>initial value of used quota</td><td>Two arguments, unsigned interger (64 bit) and string: bytes, kbytes, mbytes</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expressions">Expressions<a class="hash-link" href="#expressions" title="标题的直接链接">​</a></h2><p>Expressions represent values, either constants like network addresses, port numbers etc. or data gathered from the packet during ruleset evaluation. Expressions can be combined using binary, logical, relational and other types of expressions to form complex or relational (match) expressions. They are also used as arguments to certain types of operations, like NAT, packet marking etc.</p><p>Each expression has a data type, which determines the size, parsing and representation of symbolic values and type compatibility with other expressions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="describe-command">describe command<a class="hash-link" href="#describe-command" title="标题的直接链接">​</a></h3><p><code>describe {expression}</code></p><p>The <strong><em>describe</em></strong> command shows information about the type of an expression and its data type.</p><p><strong><em>示例 3. The <code>describe</code> command</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ nft describe tcp flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload expression, datatype tcp_flag (TCP flag) (basetype bitmask, integer), 8 bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre-defined symbolic constants:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fin                               0x01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syn                               0x02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rst                               0x04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psh                               0x08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ack                               0x10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">urg                               0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ecn                               0x40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cwr                               0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-types">Data types<a class="hash-link" href="#data-types" title="标题的直接链接">​</a></h2><p>Data types determine the size, parsing and representation of symbolic values and type compatibility of expressions. A number of global data types exist, in addition some expression types define further data types specific to the expression type. Most data types have a fixed size, some however may have a dynamic size, f.i. the string type.</p><p>Types may be derived from lower order types, f.i. the IPv4 address type is derived from the integer type, meaning an IPv4 address can also be specified as an integer value.</p><p>In certain contexts (set and map definitions) it is necessary to explicitly specify a data type. Each type has a name which is used for this.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="integer-type">Integer type<a class="hash-link" href="#integer-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 9.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Integer</td><td>integer</td><td>variable</td><td>-</td></tr></tbody></table><p>The integer type is used for numeric values. It may be specified as decimal, hexadecimal or octal number. The integer type doesn&#x27;t have a fixed size, its size is determined by the expression for which it is used.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bitmask-type">Bitmask type<a class="hash-link" href="#bitmask-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 10.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Bitmask</td><td>bitmask</td><td>variable</td><td>integer</td></tr></tbody></table><p>The bitmask type (<strong><em>bitmask</em></strong>) is used for bitmasks.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="string-type">String type<a class="hash-link" href="#string-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 11.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>String</td><td>string</td><td>variable</td><td>-</td></tr></tbody></table><p>The string type is used to for character strings. A string begins with an alphabetic character (a-zA-Z) followed by zero or more alphanumeric characters or the characters /, -, _ and .. In addition anything enclosed in double quotes (&quot;) is recognized as a string.</p><p><strong><em>示例 4. String specification</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Interface name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iifname eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Weird interface name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iifname &quot;(eth0)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="link-layer-address-type">Link layer address type<a class="hash-link" href="#link-layer-address-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 12.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Link layer address</td><td>lladdr</td><td>variable</td><td>integer</td></tr></tbody></table><p>The link layer address type is used for link layer addresses. Link layer addresses are specified as a variable amount of groups of two hexadecimal digits separated using colons (:).</p><p><strong><em>示例 5. Link layer address specification</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Ethernet destination MAC address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input ether daddr 20:c9:d0:43:12:d9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4-address-type">IPv4 address type<a class="hash-link" href="#ipv4-address-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 13.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>IPv4 address</td><td>ipv4_addr</td><td>32 bit</td><td>integer</td></tr></tbody></table><p>The IPv4 address type is used for IPv4 addresses. Addresses are specified in either dotted decimal, dotted hexadecimal, dotted octal, decimal, hexadecimal, octal notation or as a host name. A host name will be resolved using the standard system resolver.</p><p><strong><em>示例 6. IPv4 address specification</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># dotted decimal notation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output ip daddr 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># host name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output ip daddr localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv6-address-type">IPv6 address type<a class="hash-link" href="#ipv6-address-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 14.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>IPv6 address</td><td>ipv6_addr</td><td>128 bit</td><td>integer</td></tr></tbody></table><p>The IPv6 address type is used for IPv6 addresses. FIXME</p><p><strong><em>示例 7. IPv6 address specification</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># abbreviated loopback address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output ip6 daddr ::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="boolean-type">Boolean type<a class="hash-link" href="#boolean-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 15.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Boolean</td><td>boolean</td><td>1 bit</td><td>integer</td></tr></tbody></table><p>The boolean type is a syntactical helper type in user space. It&#x27;s use is in the right-hand side of a (typically implicit) relational expression to change the expression on the left-hand side into a boolean check (usually for existence).</p><p>The following keywords will automatically resolve into a boolean type with given value:</p><p><strong><em>Table 16.</em></strong></p><table><thead><tr><th>Keyword</th><th>Value</th></tr></thead><tbody><tr><td>exists</td><td>1</td></tr><tr><td>missing</td><td>0</td></tr></tbody></table><p><strong><em>示例 8. Boolean specification</em></strong></p><p>The following expressions support a boolean comparison:</p><p><strong><em>Table 17.</em></strong></p><table><thead><tr><th>Expression</th><th>Behaviour</th></tr></thead><tbody><tr><td>fib</td><td>Check route existence.</td></tr><tr><td>exthdr</td><td>Check IPv6 extension header existence.</td></tr><tr><td>tcp option</td><td>Check TCP option header existence.</td></tr></tbody></table><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># match if route exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input fib daddr . iif oif exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match only non-fragmented packets in IPv6 traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input exthdr frag missing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match if TCP timestamp option is present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input tcp option timestamp exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmp-type-type">ICMP Type type<a class="hash-link" href="#icmp-type-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 18.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>ICMP Type</td><td>icmp_type</td><td>8 bit</td><td>integer</td></tr></tbody></table><p>The ICMP Type type is used to conveniently specify the ICMP header&#x27;s type field.</p><p>The following keywords may be used when specifying the ICMP type:</p><p><strong><em>Table 19.</em></strong></p><table><thead><tr><th>Keyword</th><th>Value</th></tr></thead><tbody><tr><td>echo-reply</td><td>0</td></tr><tr><td>destination-unreachable</td><td>3</td></tr><tr><td>source-quench</td><td>4</td></tr><tr><td>redirect</td><td>5</td></tr><tr><td>echo-request</td><td>8</td></tr><tr><td>router-advertisement</td><td>9</td></tr><tr><td>router-solicitation</td><td>10</td></tr><tr><td>time-exceeded</td><td>11</td></tr><tr><td>parameter-problem</td><td>12</td></tr><tr><td>timestamp-request</td><td>13</td></tr><tr><td>timestamp-reply</td><td>14</td></tr><tr><td>info-request</td><td>15</td></tr><tr><td>info-reply</td><td>16</td></tr><tr><td>address-mask-request</td><td>17</td></tr><tr><td>address-mask-reply</td><td>18</td></tr></tbody></table><p><strong><em>示例 9. ICMP Type specification</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match ping packets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output icmp type { echo-request, echo-reply }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmpv6-type-type">ICMPv6 Type type<a class="hash-link" href="#icmpv6-type-type" title="标题的直接链接">​</a></h3><p><strong><em>Table 20.</em></strong></p><table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>ICMPv6 Type</td><td>icmpv6_type</td><td>8 bit</td><td>integer</td></tr></tbody></table><p>The ICMPv6 Type type is used to conveniently specify the ICMPv6 header&#x27;s type field.</p><p>The following keywords may be used when specifying the ICMPv6 type:</p><p><strong><em>Table 21.</em></strong></p><table><thead><tr><th>Keyword</th><th>Value</th></tr></thead><tbody><tr><td>destination-unreachable</td><td>1</td></tr><tr><td>packet-too-big</td><td>2</td></tr><tr><td>time-exceeded</td><td>3</td></tr><tr><td>parameter-problem</td><td>4</td></tr><tr><td>echo-request</td><td>128</td></tr><tr><td>echo-reply</td><td>129</td></tr><tr><td>mld-listener-query</td><td>130</td></tr><tr><td>mld-listener-report</td><td>131</td></tr><tr><td>mld-listener-done</td><td>132</td></tr><tr><td>mld-listener-reduction</td><td>132</td></tr><tr><td>nd-router-solicit</td><td>133</td></tr><tr><td>nd-router-advert</td><td>134</td></tr><tr><td>nd-neighbor-solicit</td><td>135</td></tr><tr><td>nd-neighbor-advert</td><td>136</td></tr><tr><td>nd-redirect</td><td>137</td></tr><tr><td>router-renumbering</td><td>138</td></tr><tr><td>ind-neighbor-solicit</td><td>141</td></tr><tr><td>ind-neighbor-advert</td><td>142</td></tr><tr><td>mld2-listener-report</td><td>143</td></tr></tbody></table><p><strong><em>示例 10. ICMPv6 Type specification</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match ICMPv6 ping packets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output icmpv6 type { echo-request, echo-reply }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="primary-expressions">Primary expressions<a class="hash-link" href="#primary-expressions" title="标题的直接链接">​</a></h2><p>The lowest order expression is a primary expression, representing either a constant or a single datum from a packet&#x27;s payload, meta data or a stateful module.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="meta-expressions">Meta expressions<a class="hash-link" href="#meta-expressions" title="标题的直接链接">​</a></h3><p><code>meta {length | nfproto | l4proto | protocol | priority}</code></p><p><code>[meta] {mark | iif | iifname | iiftype | oif | oifname | oiftype}</code>
<code>[meta] {skuid | skgid | nftrace | rtclassid | ibriport | obriport | pkttype | cpu | iifgroup | oifgroup | cgroup | random}</code></p><p>A meta expression refers to meta data associated with a packet.</p><p>There are two types of meta expressions: unqualified and qualified meta expressions. Qualified meta expressions require the <strong><em>meta</em></strong> keyword before the meta key, unqualified meta expressions can be specified by using the meta key directly or as qualified meta expressions.</p><p><strong><em>Table 22. Meta expression types</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>length</td><td>Length of the packet in bytes</td><td>integer (32 bit)</td></tr><tr><td>protocol</td><td>Ethertype protocol value</td><td>ether_type</td></tr><tr><td>priority</td><td>TC packet priority</td><td>tc_handle</td></tr><tr><td>mark</td><td>Packet mark</td><td>mark</td></tr><tr><td>iif</td><td>Input interface index</td><td>iface_index</td></tr><tr><td>iifname</td><td>Input interface name</td><td>string</td></tr><tr><td>iiftype</td><td>Input interface type</td><td>iface_type</td></tr><tr><td>oif</td><td>Output interface index</td><td>iface_index</td></tr><tr><td>oifname</td><td>Output interface name</td><td>string</td></tr><tr><td>oiftype</td><td>Output interface hardware type</td><td>iface_type</td></tr><tr><td>skuid</td><td>UID associated with originating socket</td><td>uid</td></tr><tr><td>skgid</td><td>GID associated with originating socket</td><td>gid</td></tr><tr><td>rtclassid</td><td>Routing realm</td><td>realm</td></tr><tr><td>ibriport</td><td>Input bridge interface name</td><td>string</td></tr><tr><td>obriport</td><td>Output bridge interface name</td><td>string</td></tr><tr><td>pkttype</td><td>packet type</td><td>pkt_type</td></tr><tr><td>cpu</td><td>cpu number processing the packet</td><td>integer (32 bits)</td></tr><tr><td>iifgroup</td><td>incoming device group</td><td>devgroup</td></tr><tr><td>oifgroup</td><td>outgoing device group</td><td>devgroup</td></tr><tr><td>cgroup</td><td>control group id</td><td>integer (32 bits)</td></tr><tr><td>random</td><td>pseudo-random number</td><td>integer (32 bits)</td></tr></tbody></table><p><strong><em>Table 23. Meta expression specific types</em></strong></p><table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>iface_index</td><td>Interface index (32 bit number). Can be specified numerically or as name of an existing interface.</td></tr><tr><td>ifname</td><td>Interface name (16 byte string). Does not have to exist.</td></tr><tr><td>iface_type</td><td>Interface type (16 bit number).</td></tr><tr><td>uid</td><td>User ID (32 bit number). Can be specified numerically or as user name.</td></tr><tr><td>gid</td><td>Group ID (32 bit number). Can be specified numerically or as group name.</td></tr><tr><td>realm</td><td>Routing Realm (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/rt_realms.</td></tr><tr><td>devgroup_type</td><td>Device group (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/group.</td></tr><tr><td>pkt_type</td><td>Packet type: Unicast (addressed to local host), Broadcast (to all), Multicast (to group).</td></tr></tbody></table><p><strong><em>示例 11. Using meta expressions</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qualified meta expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output meta oif eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># unqualified meta expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output oif eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fib-expressions">fib expressions<a class="hash-link" href="#fib-expressions" title="标题的直接链接">​</a></h3><p><strong><em>fib</em></strong> {saddr | daddr <!-- -->[mark | iif | oif]<!-- -->} {oif | oifname | type}</p><p>A fib expression queries the fib (forwarding information base) to obtain information such as the output interface index a particular address would use. The input is a tuple of elements that is used as input to the fib lookup functions.</p><p><strong><em>Table 24. fib expression specific types</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>oif</td><td>Output interface index</td><td>integer (32 bit)</td></tr><tr><td>oifname</td><td>Output interface name</td><td>string</td></tr><tr><td>type</td><td>Address type</td><td>fib_addrtype</td></tr></tbody></table><p><strong><em>示例 12. Using fib expressions</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># drop packets without a reverse path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter prerouting fib saddr . iif oif missing drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># drop packets to address not configured on ininterface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter prerouting fib daddr . iif type != { local, broadcast, multicast } drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># perform lookup in a specific &#x27;blackhole&#x27; table (0xdead, needs ip appropriate ip rule)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter prerouting meta mark set 0xdead fib daddr . mark type vmap { blackhole : drop, prohibit : jump prohibited, unreachable : drop }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="routing-expressions">Routing expressions<a class="hash-link" href="#routing-expressions" title="标题的直接链接">​</a></h3><p><strong><em>rt</em></strong> {classid | nexthop}</p><p>A routing expression refers to routing data associated with a packet.</p><p><strong><em>Table 25. Routing expression types</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>classid</td><td>Routing realm</td><td>realm</td></tr><tr><td>nexthop</td><td>Routing nexthop</td><td>ipv4_addr/ipv6_addr</td></tr></tbody></table><p><strong><em>Table 26. Routing expression specific types</em></strong></p><table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>realm</td><td>Routing Realm (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/rt_realms.</td></tr></tbody></table><p><strong><em>示例 13. Using routing expressions</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IP family independent rt expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output rt classid 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IP family dependent rt expressions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip filter output rt nexthop 192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip6 filter output rt nexthop fd00::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inet filter meta nfproto ipv4 output rt nexthop 192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inet filter meta nfproto ipv6 output rt nexthop fd00::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="payload-expressions">Payload expressions<a class="hash-link" href="#payload-expressions" title="标题的直接链接">​</a></h2><p>Payload expressions refer to data from the packet&#x27;s payload.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ethernet-header-expression">Ethernet header expression<a class="hash-link" href="#ethernet-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>ether</em></strong> <!-- -->[<em>ethernet header field</em>]</p><p><strong><em>Table 27. Ethernet header expression types</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>daddr</td><td>Destination MAC address</td><td>ether_addr</td></tr><tr><td>saddr</td><td>Source MAC address</td><td>ether_addr</td></tr><tr><td>type</td><td>EtherType</td><td>ether_type</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vlan-header-expression">VLAN header expression<a class="hash-link" href="#vlan-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>vlan</em></strong> <!-- -->[<em>VLAN header field</em>]</p><p><strong><em>Table 28. VLAN header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>id</td><td>VLAN ID (VID)</td><td>integer (12 bit)</td></tr><tr><td>cfi</td><td>Canonical Format Indicator</td><td>integer (1 bit)</td></tr><tr><td>pcp</td><td>Priority code point</td><td>integer (3 bit)</td></tr><tr><td>type</td><td>EtherType</td><td>ether_type</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="arp-header-expression">ARP header expression<a class="hash-link" href="#arp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>arp</em></strong> <!-- -->[<em>ARP header field</em>]</p><p><strong><em>Table 29. ARP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>htype</td><td>ARP hardware type</td><td>integer (16 bit)</td></tr><tr><td>ptype</td><td>EtherType</td><td>ether_type</td></tr><tr><td>hlen</td><td>Hardware address len</td><td>integer (8 bit)</td></tr><tr><td>plen</td><td>Protocol address len</td><td>integer (8 bit)</td></tr><tr><td>operation</td><td>Operation</td><td>arp_op</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4-header-expression">IPv4 header expression<a class="hash-link" href="#ipv4-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>ip</em></strong> <!-- -->[<em>IPv4 header field</em>]</p><p><strong><em>Table 30. IPv4 header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>version</td><td>IP header version (4)</td><td>integer (4 bit)</td></tr><tr><td>hdrlength</td><td>IP header length including options</td><td>integer (4 bit) FIXME scaling</td></tr><tr><td>dscp</td><td>Differentiated Services Code Point</td><td>dscp</td></tr><tr><td>ecn</td><td>Explicit Congestion Notification</td><td>ecn</td></tr><tr><td>length</td><td>Total packet length</td><td>integer (16 bit)</td></tr><tr><td>id</td><td>IP ID</td><td>integer (16 bit)</td></tr><tr><td>frag-off</td><td>Fragment offset</td><td>integer (16 bit)</td></tr><tr><td>ttl</td><td>Time to live</td><td>integer (8 bit)</td></tr><tr><td>protocol</td><td>Upper layer protocol</td><td>inet_proto</td></tr><tr><td>checksum</td><td>IP header checksum</td><td>integer (16 bit)</td></tr><tr><td>saddr</td><td>Source address</td><td>ipv4_addr</td></tr><tr><td>daddr</td><td>Destination address</td><td>ipv4_addr</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmp-header-expression">ICMP header expression<a class="hash-link" href="#icmp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>icmp</em></strong> <!-- -->[<em>ICMP header field</em>]</p><p><strong><em>Table 31. ICMP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>ICMP type field</td><td>icmp_type</td></tr><tr><td>code</td><td>ICMP code field</td><td>integer (8 bit)</td></tr><tr><td>checksum</td><td>ICMP checksum field</td><td>integer (16 bit)</td></tr><tr><td>id</td><td>ID of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>sequence</td><td>sequence number of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>gateway</td><td>gateway of redirects</td><td>integer (32 bit)</td></tr><tr><td>mtu</td><td>MTU of path MTU discovery</td><td>integer (16 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv6-header-expression">IPv6 header expression<a class="hash-link" href="#ipv6-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>ip6</em></strong> <!-- -->[<em>IPv6 header field</em>]</p><p><strong><em>Table 32. IPv6 header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>version</td><td>IP header version (6)</td><td>integer (4 bit)</td></tr><tr><td>dscp</td><td>Differentiated Services Code Point</td><td>dscp</td></tr><tr><td>ecn</td><td>Explicit Congestion Notification</td><td>ecn</td></tr><tr><td>flowlabel</td><td>Flow label</td><td>integer (20 bit)</td></tr><tr><td>length</td><td>Payload length</td><td>integer (16 bit)</td></tr><tr><td>nexthdr</td><td>Nexthdr protocol</td><td>inet_proto</td></tr><tr><td>hoplimit</td><td>Hop limit</td><td>integer (8 bit)</td></tr><tr><td>saddr</td><td>Source address</td><td>ipv6_addr</td></tr><tr><td>daddr</td><td>Destination address</td><td>ipv6_addr</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmpv6-header-expression">ICMPv6 header expression<a class="hash-link" href="#icmpv6-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>icmpv6</em></strong> <!-- -->[<em>ICMPv6 header field</em>]</p><p><strong><em>Table 33. ICMPv6 header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>ICMPv6 type field</td><td>icmpv6_type</td></tr><tr><td>code</td><td>ICMPv6 code field</td><td>integer (8 bit)</td></tr><tr><td>checksum</td><td>ICMPv6 checksum field</td><td>integer (16 bit)</td></tr><tr><td>parameter-problem</td><td>pointer to problem</td><td>integer (32 bit)</td></tr><tr><td>packet-too-big</td><td>oversized MTU</td><td>integer (32 bit)</td></tr><tr><td>id</td><td>ID of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>sequence</td><td>sequence number of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>max-delay</td><td>maximum response delay of MLD queries</td><td>integer (16 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcp-header-expression">TCP header expression<a class="hash-link" href="#tcp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>tcp</em></strong> <!-- -->[<em>TCP header field</em>]</p><p><strong><em>Table 34. TCP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>sequence</td><td>Sequence number</td><td>integer (32 bit)</td></tr><tr><td>ackseq</td><td>Acknowledgement number</td><td>integer (32 bit)</td></tr><tr><td>doff</td><td>Data offset</td><td>integer (4 bit) FIXME scaling</td></tr><tr><td>reserved</td><td>Reserved area</td><td>integer (4 bit)</td></tr><tr><td>flags</td><td>TCP flags</td><td>tcp_flag</td></tr><tr><td>window</td><td>Window</td><td>integer (16 bit)</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (16 bit)</td></tr><tr><td>urgptr</td><td>Urgent pointer</td><td>integer (16 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="udp-header-expression">UDP header expression<a class="hash-link" href="#udp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>udp</em></strong> <!-- -->[<em>UDP header field</em>]</p><p><strong><em>Table 35. UDP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>length</td><td>Total packet length</td><td>integer (16 bit)</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (16 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="udp-lite-header-expression">UDP-Lite header expression<a class="hash-link" href="#udp-lite-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>udplite</em></strong> <!-- -->[<em>UDP-Lite header field</em>]</p><p><strong><em>Table 36. UDP-Lite header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (16 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sctp-header-expression">SCTP header expression<a class="hash-link" href="#sctp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>sctp</em></strong> <!-- -->[<em>SCTP header field</em>]</p><p><strong><em>Table 37. SCTP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>vtag</td><td>Verfication Tag</td><td>integer (32 bit)</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (32 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dccp-header-expression">DCCP header expression<a class="hash-link" href="#dccp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>dccp</em></strong> <!-- -->[<em>DCCP header field</em>]</p><p><strong><em>Table 38. DCCP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentication-header-expression">Authentication header expression<a class="hash-link" href="#authentication-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>ah</em></strong> <!-- -->[<em>AH header field</em>]</p><p><strong><em>Table 39. AH header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>nexthdr</td><td>Next header protocol</td><td>inet_proto</td></tr><tr><td>hdrlength</td><td>AH Header length</td><td>integer (8 bit)</td></tr><tr><td>reserved</td><td>Reserved area</td><td>integer (16 bit)</td></tr><tr><td>spi</td><td>Security Parameter Index</td><td>integer (32 bit)</td></tr><tr><td>sequence</td><td>Sequence number</td><td>integer (32 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="encrypted-security-payload-header-expression">Encrypted security payload header expression<a class="hash-link" href="#encrypted-security-payload-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>esp</em></strong> <!-- -->[<em>ESP header field</em>]</p><p><strong><em>Table 40. ESP header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>spi</td><td>Security Parameter Index</td><td>integer (32 bit)</td></tr><tr><td>sequence</td><td>Sequence number</td><td>integer (32 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipcomp-header-expression">IPcomp header expression<a class="hash-link" href="#ipcomp-header-expression" title="标题的直接链接">​</a></h3><p><strong><em>comp</em></strong> <!-- -->[<em>IPComp header field</em>]</p><p><strong><em>Table 41. IPComp header expression</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>nexthdr</td><td>Next header protocol</td><td>inet_proto</td></tr><tr><td>flags</td><td>Flags</td><td>bitmask</td></tr><tr><td>cpi</td><td>Compression Parameter Index</td><td>integer (16 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="extension-header-expressions">Extension header expressions<a class="hash-link" href="#extension-header-expressions" title="标题的直接链接">​</a></h3><p>Extension header expressions refer to data from variable-sized protocol headers, such as IPv6 extension headers and TCPs options.</p><p>nftables currently supports matching (finding) a given ipv6 extension header or TCP option.</p><p><code>hbh {nexthdr | hdrlength}</code></p><p><code>frag {nexthdr | frag-off | more-fragments | id}</code></p><p><code>rt {nexthdr | hdrlength | type | seg-left}</code></p><p><code>dst {nexthdr | hdrlength}</code></p><p><code>mh {nexthdr | hdrlength | checksum | type}</code></p><p><code>tcp option {eol | noop | maxseg | window | sack-permitted | sack | sack0 | sack1 | sack2 | sack3 | timestamp} [_tcp_option_field_]</code></p><p>The following syntaxes are valid only in a relational expression with boolean type on right-hand side for checking header existence only:</p><p><code>exthdr {hbh | frag | rt | dst | mh}</code></p><p><code>tcp option {eol | noop | maxseg | window | sack-permitted | sack | sack0 | sack1 | sack2 | sack3 | timestamp}</code></p><p><strong><em>Table 42. IPv6 extension headers</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th></tr></thead><tbody><tr><td>hbh</td><td>Hop by Hop</td></tr><tr><td>rt</td><td>Routing Header</td></tr><tr><td>frag</td><td>Fragmentation header</td></tr><tr><td>dst</td><td>dst options</td></tr><tr><td>mh</td><td>Mobility Header</td></tr></tbody></table><p><strong><em>Table 43. TCP Options</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>TCP option fields</th></tr></thead><tbody><tr><td>eol</td><td>End of option list</td><td>kind</td></tr><tr><td>noop</td><td>1 Byte TCP No-op options</td><td>kind</td></tr><tr><td>maxseg</td><td>TCP Maximum Segment Size</td><td>kind, length, size</td></tr><tr><td>window</td><td>TCP Window Scaling</td><td>kind, length, count</td></tr><tr><td>sack-permitted</td><td>TCP SACK permitted</td><td>kind, length</td></tr><tr><td>sack</td><td>TCP Selective Acknowledgement (alias of block 0)</td><td>kind, length, left, right</td></tr><tr><td>sack0</td><td>TCP Selective Acknowledgement (block 0)</td><td>kind, length, left, right</td></tr><tr><td>sack1</td><td>TCP Selective Acknowledgement (block 1)</td><td>kind, length, left, right</td></tr><tr><td>sack2</td><td>TCP Selective Acknowledgement (block 2)</td><td>kind, length, left, right</td></tr><tr><td>sack3</td><td>TCP Selective Acknowledgement (block 3)</td><td>kind, length, left, right</td></tr><tr><td>timestamp</td><td>TCP Timestamps</td><td>kind, length, tsval, tsecr</td></tr></tbody></table><p><strong><em>示例 14. finding TCP options</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">filter input tcp option sack-permitted kind 1 counter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 15. matching IPv6 exthdr</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ip6 filter input frag more-fragments 1 counter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conntrack-expressions">Conntrack expressions<a class="hash-link" href="#conntrack-expressions" title="标题的直接链接">​</a></h3><p>Conntrack expressions refer to meta data of the connection tracking entry associated with a packet.</p><p>There are three types of conntrack expressions. Some conntrack expressions require the flow direction before the conntrack key, others must be used directly because they are direction agnostic. The <strong><em>packets</em></strong>, <strong><em>bytes</em></strong> and <strong><em>avgpkt</em></strong> keywords can be used with or without a direction. If the direction is omitted, the sum of the original and the reply direction is returned. The same is true for the <strong><em>zone</em></strong>, if a direction is given, the zone is only matched if the zone id is tied to the given direction.</p><p><code>ct {state | direction | status | mark | expiration | helper | label | l3proto | protocol | bytes | packets | avgpkt | zone}</code></p><p><code>ct {original | reply} {l3proto | protocol | saddr | daddr | proto-src | proto-dst | bytes | packets | avgpkt | zone}</code></p><p><strong><em>Table 44. Conntrack expressions</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>state</td><td>State of the connection</td><td>ct_state</td></tr><tr><td>direction</td><td>Direction of the packet relative to the connection</td><td>ct_dir</td></tr><tr><td>status</td><td>Status of the connection</td><td>ct_status</td></tr><tr><td>mark</td><td>Connection mark</td><td>mark</td></tr><tr><td>expiration</td><td>Connection expiration time</td><td>time</td></tr><tr><td>helper</td><td>Helper associated with the connection</td><td>string</td></tr><tr><td>label</td><td>Connection tracking label bit or symbolic name defined in connlabel.conf in the nftables include path</td><td>ct_label</td></tr><tr><td>l3proto</td><td>Layer 3 protocol of the connection</td><td>nf_proto</td></tr><tr><td>saddr</td><td>Source address of the connection for the given direction</td><td>ipv4_addr/ipv6_addr</td></tr><tr><td>daddr</td><td>Destination address of the connection for the given direction</td><td>ipv4_addr/ipv6_addr</td></tr><tr><td>protocol</td><td>Layer 4 protocol of the connection for the given direction</td><td>inet_proto</td></tr><tr><td>proto-src</td><td>Layer 4 protocol source for the given direction</td><td>integer (16 bit)</td></tr><tr><td>proto-dst</td><td>Layer 4 protocol destination for the given direction</td><td>integer (16 bit)</td></tr><tr><td>packets</td><td>packet count seen in the given direction or sum of original and reply</td><td>integer (64 bit)</td></tr><tr><td>bytes</td><td>bytecount seen, see description for <strong><em>packets</em></strong> keyword</td><td>integer (64 bit)</td></tr><tr><td>avgpkt</td><td>average bytes per packet, see description for <strong><em>packets</em></strong> keyword</td><td>integer (64 bit)</td></tr><tr><td>zone</td><td>conntrack zone</td><td>integer (16 bit)</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="statements">Statements<a class="hash-link" href="#statements" title="标题的直接链接">​</a></h2><p>Statements represent actions to be performed. They can alter control flow (return, jump to a different chain, accept or drop the packet) or can perform actions, such as logging, rejecting a packet, etc.</p><p>Statements exist in two kinds. Terminal statements unconditionally terminate evaluation of the current rule, non-terminal statements either only conditionally or never terminate evaluation of the current rule, in other words, they are passive from the ruleset evaluation perspective. There can be an arbitrary amount of non-terminal statements in a rule, but only a single terminal statement as the final statement.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="verdict-statement">Verdict statement<a class="hash-link" href="#verdict-statement" title="标题的直接链接">​</a></h3><p>The verdict statement alters control flow in the ruleset and issues policy decisions for packets.</p><p><code>{accept | drop | queue | continue | return}</code></p><p><code>{jump | goto} {chain}</code></p><p><code>accept</code></p><dd><p>Terminate ruleset evaluation and accept the packet.</p></dd><p><code>drop</code></p><dd><p>Terminate ruleset evaluation and drop the packet.</p></dd><p><code>queue</code></p><dd><p>Terminate ruleset evaluation and queue the packet to userspace.</p></dd><p><code>continue</code></p><dd><p>Continue ruleset evaluation with the next rule. FIXME</p></dd><p><code>return</code></p><dd><p>Return from the current chain and continue evaluation at the next rule in the last chain. If issued in a base chain, it is equivalent to <strong><em>accept</em></strong>.</p></dd><p><code>jump chain</code></p><dd><p>Continue evaluation at the first rule in chain. The current position in the ruleset is pushed to a call stack and evaluation will continue there when the new chain is entirely evaluated of a <strong><em>return</em></strong> verdict is issued.</p></dd><p><code>goto chain</code></p><dd><p>Similar to <strong><em>jump</em></strong>, but the current position is not pushed to the call stack, meaning that after the new chain evaluation will continue at the last chain instead of the one containing the goto statement.</p></dd><p><strong><em>示例 16. Verdict statements</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># process packets from eth0 and the internal network in from_lan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># chain, drop all packets from eth0 with different source addresses.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iif eth0 ip saddr 192.168.0.0/24 jump from_lan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iif eth0 drop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="payload-statement">Payload statement<a class="hash-link" href="#payload-statement" title="标题的直接链接">​</a></h3><p>The payload statement alters packet content. It can be used for example to set ip DSCP (differv) header field or ipv6 flow labels.</p><p><strong><em>示例 17. route some packets instead of bridging</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># redirect tcp:http from 192.160.0.0/16 to local machine for routing instead of bridging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># assumes 00:11:22:33:44:55 is local MAC address.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bridge input meta iif eth0 ip saddr 192.168.0.0/16 tcp dport 80 meta pkttype set unicast ether daddr set 00:11:22:33:44:55</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 18. Set IPv4 DSCP header field</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ip forward ip dscp set 42</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="log-statement">Log statement<a class="hash-link" href="#log-statement" title="标题的直接链接">​</a></h3><p><code>log [prefix _quoted_string_] [level _syslog-level_] [flags log-flags]</code></p><p><code>log [group _nflog_group_] [prefix _quoted_string_] [queue-threshold value] [snaplen size]</code></p><p>The log statement enables logging of matching packets. When this statement is used from a rule, the Linux kernel will print some information on all matching packets, such as header fields, via the kernel log (where it can be read with dmesg(1) or read in the syslog). If the group number is specified, the Linux kernel will pass the packet to nfnetlink_log which will multicast the packet through a netlink socket to the specified multicast group. One or more userspace processes may subscribe to the group to receive the packets, see libnetfilter_queue documentation for details. This is a non-terminating statement, so the rule evaluation continues after the packet is logged.</p><p><strong><em>Table 45. log statement options</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>prefix</td><td>Log message prefix</td><td>quoted string</td></tr><tr><td>syslog-level</td><td>Syslog level of logging</td><td>string: emerg, alert, crit, err, warn <!-- -->[default]<!-- -->, notice, info, debug</td></tr><tr><td>group</td><td>NFLOG group to send messages to</td><td>unsigned integer (16 bit)</td></tr><tr><td>snaplen</td><td>Length of packet payload to include in netlink message</td><td>unsigned integer (32 bit)</td></tr><tr><td>queue-threshold</td><td>Number of packets to queue inside the kernel before sending them to userspace</td><td>unsigned integer (32 bit)</td></tr></tbody></table><p><strong><em>Table 46. log-flags</em></strong></p><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td>tcp sequence</td><td>Log TCP sequence numbers.</td></tr><tr><td>tcp options</td><td>Log options from the TCP packet header.</td></tr><tr><td>ip options</td><td>Log options from the IP/IPv6 packet header.</td></tr><tr><td>skuid</td><td>Log the userid of the process which generated the packet.</td></tr><tr><td>ether</td><td>Decode MAC addresses and protocol.</td></tr><tr><td>all</td><td>Enable all log flags listed above.</td></tr></tbody></table><p><strong><em>示例 19. Using log statement</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># log the UID which generated the packet and ip options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip filter output log flags skuid flags ip options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># log the tcp sequence numbers and tcp options from the TCP packet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip filter output log flags tcp sequence,options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># enable all supported log flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip6 filter output log flags all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reject-statement">Reject statement<a class="hash-link" href="#reject-statement" title="标题的直接链接">​</a></h3><p><code>reject [with] {icmp | icmp6 | icmpx} [type] {icmp_type | icmp6_type | icmpx_type}</code></p><p><code>reject [with] {tcp} {reset}</code></p><p>A reject statement is used to send back an error packet in response to the matched packet otherwise it is equivalent to drop so it is a terminating statement, ending rule traversal. This statement is only valid in the input, forward and output chains, and user-defined chains which are only called from those chains.</p><p><strong><em>Table 47. reject statement type (ip)</em></strong></p><table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>icmp_type</td><td>ICMP type response to be sent to the host</td><td>net-unreachable, host-unreachable, prot-unreachable, port-unreachable <!-- -->[default]<!-- -->, net-prohibited, host-prohibited, admin-prohibited</td></tr></tbody></table><p><strong><em>Table 48. reject statement type (ip6)</em></strong></p><table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>icmp6_type</td><td>ICMPv6 type response to be sent to the host</td><td>no-route, admin-prohibited, addr-unreachable, port-unreachable <!-- -->[default]<!-- -->, policy-fail, reject-route</td></tr></tbody></table><p><strong><em>Table 49. reject statement type (inet)</em></strong></p><table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>icmpx_type</td><td>ICMPvXtype abstraction response to be sent to the host, this is a set of types that overlap in IPv4 and IPv6 to be used from the inet family.</td><td>port-unreachable <!-- -->[default]<!-- -->, admin-prohibited, no-route, host-unreachable</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="counter-statement">Counter statement<a class="hash-link" href="#counter-statement" title="标题的直接链接">​</a></h3><p>A counter statement sets the hit count of packets along with the number of bytes.</p><p><code>counter {packets _number_ } {bytes _number_ }</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conntrack-statement">Conntrack statement<a class="hash-link" href="#conntrack-statement" title="标题的直接链接">​</a></h3><p>The conntrack statement can be used to set the conntrack mark and conntrack labels.</p><p><code>ct {mark | eventmask | label | zone} [set] value</code></p><p>The ct statement sets meta data associated with a connection. The zone id has to be assigned before a conntrack lookup takes place, i.e. this has to be done in prerouting and possibly output (if locally generated packets need to be placed in a distinct zone), with a hook priority of -300.</p><p><strong><em>Table 50. Conntrack statement types</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Value</th></tr></thead><tbody><tr><td>eventmask</td><td>conntrack event bits</td><td>bitmask, integer (32 bit)</td></tr><tr><td>helper</td><td>name of ct helper object to assign to the connection</td><td>quoted string</td></tr><tr><td>mark</td><td>Connection tracking mark</td><td>mark</td></tr><tr><td>label</td><td>Connection tracking label</td><td>label</td></tr><tr><td>zone</td><td>conntrack zone</td><td>integer (16 bit)</td></tr></tbody></table><p><strong><em>示例 20. save packet nfmark in conntrack</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ct mark set meta mark</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 21. set zone mapped via interface</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table inet raw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chain prerouting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type filter hook prerouting priority -300;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ct zone set iif map { &quot;eth1&quot; : 1, &quot;veth1&quot; : 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chain output {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type filter hook output priority -300;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ct zone set oif map { &quot;eth1&quot; : 1, &quot;veth1&quot; : 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 22. restrict events reported by ctnetlink</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ct eventmask set new or related or destroy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="meta-statement">Meta statement<a class="hash-link" href="#meta-statement" title="标题的直接链接">​</a></h3><p>A meta statement sets the value of a meta expression. The existing meta fields are: priority, mark, pkttype, nftrace.</p><p><code>meta {mark | priority | pkttype | nftrace} [set] value</code></p><p>A meta statement sets meta data associated with a packet.</p><p><strong><em>Table 51. Meta statement types</em></strong></p><table><thead><tr><th>Keyword</th><th>Description</th><th>Value</th></tr></thead><tbody><tr><td>priority</td><td>TC packet priority</td><td>tc_handle</td></tr><tr><td>mark</td><td>Packet mark</td><td>mark</td></tr><tr><td>pkttype</td><td>packet type</td><td>pkt_type</td></tr><tr><td>nftrace</td><td>ruleset packet tracing on/off. Use <strong><em>monitor trace</em></strong> command to watch traces</td><td>0, 1</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="limit-statement">Limit statement<a class="hash-link" href="#limit-statement" title="标题的直接链接">​</a></h3><p><code>limit [rate] [over]_packet_number_ [/] {second | minute | hour | day} [burst _packet_number_ packets]</code></p><p><code>limit [rate] [over]_byte_number_ {bytes | kbytes | mbytes} [/] {second | minute | hour | day | week} [burst _byte_number_ bytes]</code></p><p>A limit statement matches at a limited rate using a token bucket filter. A rule using this statement will match until this limit is reached. It can be used in combination with the log statement to give limited logging. The <strong><em>over</em></strong> keyword, that is optional, makes it match over the specified rate.</p><p><strong><em>Table 52. limit statement values</em></strong></p><table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>packet_number</td><td>Number of packets</td><td>unsigned integer (32 bit)</td></tr><tr><td>byte_number</td><td>Number of bytes</td><td>unsigned integer (32 bit)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nat-statements">NAT statements<a class="hash-link" href="#nat-statements" title="标题的直接链接">​</a></h3><p><code>snat [to _address_ [:port]] [persistent, random, fully-random]</code></p><p><code>snat [to _address_ - _address_ [:_port_ - _port_]] [persistent, random, fully-random]</code></p><p><code>dnat [to _address_ [:_port_]] [persistent, random, fully-random]</code></p><p><code>dnat [to _address_ [:_port_ - _port_]] [persistent, random, fully-random]</code></p><p><code>masquerade [to [:_port_]] [persistent, random, fully-random]</code></p><p><code>masquerade [to [:_port_ - _port_]] [persistent, random, fully-random]</code></p><p><code>redirect [to [:_port_]] [persistent, random, fully-random]</code></p><p><code>redirect [to [:_port_ - _port_]] [persistent, random, fully-random]</code></p><p>The nat statements are only valid from nat chain types.</p><p>The <strong><em>snat</em></strong> and <strong><em>masquerade</em></strong> statements specify that the source address of the packet should be modified. While <strong><em>snat</em></strong> is only valid in the postrouting and input chains, <strong><em>masquerade</em></strong> makes sense only in postrouting. The <strong><em>dnat</em></strong> and <strong><em>redirect</em></strong> statements are only valid in the prerouting and output chains, they specify that the destination address of the packet should be modified. You can use non-base chains which are called from base chains of nat chain type too. All future packets in this connection will also be mangled, and rules should cease being examined.</p><p>The <strong><em>masquerade</em></strong> statement is a special form of <strong><em>snat</em></strong> which always uses the outgoing interface&#x27;s IP address to translate to. It is particularly useful on gateways with dynamic (public) IP addresses.</p><p>The <strong><em>redirect</em></strong> statement is a special form of <strong><em>dnat</em></strong> which always translates the destination address to the local host&#x27;s one. It comes in handy if one only wants to alter the destination port of incoming traffic on different interfaces.</p><p>Note that all nat statements require both prerouting and postrouting base chains to be present since otherwise packets on the return path won&#x27;t be seen by netfilter and therefore no reverse translation will take place.</p><p><strong><em>Table 53. NAT statement values</em></strong></p><table><thead><tr><th>Expression</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>address</td><td>Specifies that the source/destination address of the packet should be modified. You may specify a mapping to relate a list of tuples composed of arbitrary expression key with address value.</td><td>ipv4_addr, ipv6_addr, eg. abcd::1234, or you can use a mapping, eg. meta mark map { 10 : 192.168.1.2, 20 : 192.168.1.3 }</td></tr><tr><td>port</td><td>Specifies that the source/destination address of the packet should be modified.</td><td>port number (16 bits)</td></tr></tbody></table><p><strong><em>Table 54. NAT statement flags</em></strong></p><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td>persistent</td><td>Gives a client the same source-/destination-address for each connection.</td></tr><tr><td>random</td><td>If used then port mapping will be randomized using a random seeded MD5 hash mix using source and destination address and destination port.</td></tr><tr><td>fully-random</td><td>If used then port mapping is generated based on a 32-bit pseudo-random algorithm.</td></tr></tbody></table><p><strong><em>示例 23. Using NAT statements</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create a suitable table/chain setup for all further examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add table nat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add chain nat prerouting { type nat hook prerouting priority 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add chain nat postrouting { type nat hook postrouting priority 100; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># translate source addresses of all packets leaving via eth0 to address 1.2.3.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat postrouting oif eth0 snat to 1.2.3.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># redirect all traffic entering via eth0 to destination address 192.168.1.120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat prerouting iif eth0 dnat to 192.168.1.120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># translate source addresses of all packets leaving via eth0 to whatever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># locally generated packets would use as source to reach the same destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat postrouting oif eth0 masquerade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># redirect incoming TCP traffic for port 22 to port 2222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat prerouting tcp dport 22 redirect to :2222</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-statement">Queue statement<a class="hash-link" href="#queue-statement" title="标题的直接链接">​</a></h3><p>This statement passes the packet to userspace using the nfnetlink_queue handler. The packet is put into the queue identified by its 16-bit queue number. Userspace can inspect and modify the packet if desired. Userspace must then drop or reinject the packet into the kernel. See libnetfilter_queue documentation for details.</p><p><code>queue [num _queue_number_] [bypass]</code></p><p><code>queue [num _queue_number_from_ - _queue_number_to_] [bypass,fanout]</code></p><p><strong><em>Table 55. queue statement values</em></strong></p><table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>queue_number</td><td>Sets queue number, default is 0.</td><td>unsigned integer (16 bit)</td></tr><tr><td>queue_number_from</td><td>Sets initial queue in the range, if fanout is used.</td><td>unsigned integer (16 bit)</td></tr><tr><td>queue_number_to</td><td>Sets closing queue in the range, if fanout is used.</td><td>unsigned integer (16 bit)</td></tr></tbody></table><p><strong><em>Table 56. queue statement flags</em></strong></p><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td>bypass</td><td>Let packets go through if userspace application cannot back off. Before using this flag, read libnetfilter_queue documentation for performance tuning recomendations.</td></tr><tr><td>fanout</td><td>Distribute packets between several queues.</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-commands">Additional commands<a class="hash-link" href="#additional-commands" title="标题的直接链接">​</a></h2><p>These are some additional commands included in nft.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="export">export<a class="hash-link" href="#export" title="标题的直接链接">​</a></h3><p>Export your current ruleset in XML or JSON format to stdout.</p><p>Examples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% nft export json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitor">monitor<a class="hash-link" href="#monitor" title="标题的直接链接">​</a></h3><p>The monitor command allows you to listen to Netlink events produced by the nf_tables subsystem, related to creation and deletion of objects. When they ocurr, nft will print to stdout the monitored events in either XML, JSON or native nft format.</p><p>To filter events related to a concrete object, use one of the keywords &#x27;tables&#x27;, &#x27;chains&#x27;, &#x27;sets&#x27;, &#x27;rules&#x27;, &#x27;elements&#x27;.</p><p>To filter events related to a concrete action, use keyword &#x27;new&#x27; or &#x27;destroy&#x27;.</p><p>Hit ^C to finish the monitor operation.</p><p><strong><em>示例 24. Listen to all events, report in native nft format</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 25. Listen to added tables, report in XML format</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor new tables xml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 26. Listen to deleted rules, report in JSON format</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor destroy rules json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 27. Listen to both new and destroyed chains, in native nft format</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor chains</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="error-reporting">Error reporting<a class="hash-link" href="#error-reporting" title="标题的直接链接">​</a></h2><p>When an error is detected, nft shows the line(s) containing the error, the position of the erroneous parts in the input stream and marks up the erroneous parts using carrets (^). If the error results from the combination of two expressions or statements, the part imposing the constraints which are violated is marked using tildes (~).</p><p>For errors returned by the kernel, nft can&#x27;t detect which parts of the input caused the error and the entire command is marked.</p><p><strong><em>示例 28. Error caused by single incorrect expression</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cmdline&gt;:1:19-22: Error: Interface does not exist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output oif eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ^^^^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 29. Error caused by invalid combination of two expressions</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cmdline&gt;:1:28-36: Error: Right hand side of relational expression (==) must be constant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output tcp dport == tcp dport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ~~ ^^^^^^^^^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>示例 30. Error returned by the kernel</em></strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cmdline&gt;:0:0-23: Error: Could not process rule: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output oif wlan0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^^^^^^^^^^^^^^^^^^^^^^^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="退出状态码">退出状态码<a class="hash-link" href="#退出状态码" title="标题的直接链接">​</a></h2><p>On success, nft exits with a status of 0. Unspecified errors cause it to exit with a status of 1, memory allocation errors with a status of 2, unable to open Netlink socket with 3.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="see-also">See Also<a class="hash-link" href="#see-also" title="标题的直接链接">​</a></h2><p>iptables(8), ip6tables(8), arptables(8), ebtables(8), ip(8), tc(8)</p><p>There is an official wiki at: <a href="http://wiki.nftables.org" target="_blank" rel="noopener noreferrer">wiki.nftables.org</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors">Authors<a class="hash-link" href="#authors" title="标题的直接链接">​</a></h2><p>nftables was written by Patrick McHardy and Pablo Neira Ayuso, among many other contributors from the Netfilter community.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="copyright">Copyright<a class="hash-link" href="#copyright" title="标题的直接链接">​</a></h2><ul><li>Copyright © 2008-2014 Patrick McHardy <a href="mailto:%5Bkaber@trash.net%5D(mailto:kaber@trash.net)" target="_blank" rel="noopener noreferrer">[kaber@trash.net](mailto:kaber@trash.net)</a></li><li>Copyright © 2013-2016 Pablo Neira Ayuso <a href="mailto:%5Bpablo@netfilter.org%5D(mailto:pablo@netfilter.org)" target="_blank" rel="noopener noreferrer">[pablo@netfilter.org](mailto:pablo@netfilter.org)</a></li></ul><p>nftables is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License version 2 as published by the Free Software Foundation.</p><p><strong><em>This documentation is licenced under the terms of the Creative Commons Attribution-ShareAlike 4.0 license, <a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">CC BY-SA 4.0</a>.</em></strong></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/nft">nft</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/nftables">nftables</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2017/05/31/first-post">开篇</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-05-31T00:00:00.000Z" itemprop="datePublished">2017年5月31日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown" itemprop="articleBody"><p>重新开始写博客，这篇作为开篇，继忙碌地工作了快两年之后，发现抽时间将一些想法和经验沉淀下来也是如此重要。而整理文章的过程本身也是对思绪的整理，可以帮助我们更好的理解所做的事情。
接下来会把旧博客的备份文章重新放上来。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2015/01/03/centos7-firewalld-basic">CENTOS7管理之动态防火墙FIREWALLD</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2015-01-03T00:00:00.000Z" itemprop="datePublished">2015年1月3日</time> · <!-- -->阅读需 12 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>firewalld 的出现带来了许多新的亮点，它使得防火墙规则管理更加方便和统一，但 firewalld 项目本身还有诸多不完善的地方，还需要一些时间的沉淀才能变得更加稳定和得到更多软件社区的支持。在我们使用过程中也发现了其存在的一些问题，我们也正在努力参与到 firewalld 的改进和测试当中，也希望有更多的人能够参与进来。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="firewalld的出现">firewalld的出现<a class="hash-link" href="#firewalld的出现" title="标题的直接链接">​</a></h2><p>自 fedora18 开始，firewalld 已经成为默认的防火墙管理组件被集成到系统中，用以取代 iptables service 服务，而基于 fedora18 开发的RHEL7，以及其一脉相承的CentOS7 也都使用 firewalld 作为默认的防火墙管理组件，无论是对于日常使用还是企业应用来讲这样的变更都或多或少的为使用者带来了影响。在浏览完本文前我们先不急着下结论到底这样的变化是好是坏，让我们“剥离它天生的骄傲，排除这些外界的干扰“，来看看 firewalld 到底是什么样的。
以下内容以 CentOS7 系统为例进行讲解，我们假设读者对于 iptables 防火墙相关知识有一定的掌握。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是动态防火墙">什么是动态防火墙？<a class="hash-link" href="#什么是动态防火墙" title="标题的直接链接">​</a></h2><p>我们首先需要弄明白的第一个问题是到底什么是动态防火墙。为了解答这个问题，我们先来回忆一下 iptables service 管理防火墙规则的模式：用户将新的防火墙规则添加进 /etc/sysconfig/iptables 配置文件当中，再执行命令 service iptables reload 使变更的规则生效。在这整个过程的背后，iptables service 首先对旧的防火墙规则进行了清空，然后重新完整地加载所有新的防火墙规则，而如果配置了需要 reload 内核模块的话，过程背后还会包含卸载和重新加载内核模块的动作，而不幸的是，这个动作很可能对运行中的系统产生额外的不良影响，特别是在网络非常繁忙的系统中。</p><p>如果我们把这种哪怕只修改一条规则也要进行所有规则的重新载入的模式称为静态防火墙的话，那么 firewalld 所提供的模式就可以叫做动态防火墙，它的出现就是为了解决这一问题，任何规则的变更都不需要对整个防火墙规则列表进行重新加载，只需要将变更部分保存并更新到运行中的 iptables 即可。</p><p>这里有必要说明一下 firewalld 和 iptables 之间的关系， firewalld 提供了一个 daemon 和 service，还有命令行和图形界面配置工具，它仅仅是替代了 iptables service 部分，其底层还是使用 iptables 作为防火墙规则管理入口。firewalld 使用 python 语言开发，在新版本中已经计划使用 c++ 重写 daemon 部分。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="firewalld-具有哪些特性">firewalld 具有哪些特性？<a class="hash-link" href="#firewalld-具有哪些特性" title="标题的直接链接">​</a></h2><p>那么 firewalld 除了是动态防火墙以外，它还具有哪些优势或者特性呢？第一个是配置文件。firewalld 的配置文件被放置在不同的 xml 文件当中，这使得对规则的维护变得更加容易和可读，有条理。相比于 iptables 的规则配置文件而言，这显然可以算作是一个进步。第二个是区域模型。firewalld 通过对 iptables 自定义链的使用，抽象出一个区域模型的概念，将原本十分灵活的自定义链统一成一套默认的标准使用规范和流程，使得防火墙在易用性和通用性上得到提升。令一个重要特性是对 ebtables 的支持，通过统一的接口来实现 ipt/ebt 的统一管理。还有一个重要特性是富语言。富语言风格的配置让规则管理变得更加人性化，学习门槛相比原生的 iptables 命令有所降低，让初学者可以在很短时间内掌握其基本用法，规则管理变得更快捷。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="firewalld-基本术语">firewalld 基本术语<a class="hash-link" href="#firewalld-基本术语" title="标题的直接链接">​</a></h2><p>本文不打算重复阐述现有文档中的基本知识，仅仅提供一些对现有文档中知识的补充和理解，详细的文档请参阅man page或本文结尾处的延伸阅读<sup id="fnref-1-c7e489"><a href="#fn-1-c7e489" class="footnote-ref">1</a></sup>部分。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="zone">zone：<a class="hash-link" href="#zone" title="标题的直接链接">​</a></h3><p>firewalld将网卡对应到不同的区域（zone），zone 默认共有9个，block  dmz  drop  external  home  internal  public  trusted  work ，不同的区域之间的差异是其对待数据包的默认行为不同，根据区域名字我们可以很直观的知道该区域的特征，在CentOS7系统中，默认区域被设置为public，而在最新版本的fedora（fedora21）当中随着 server 版和 workstation 版的分化则添加了两个不同的自定义 zone FedoraServer 和 FedoraWorkstation 分别对应两个版本。使用下面的命令分别列出所有支持的 zone 和查看当前的默认 zone：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --get-zones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --get-default-zone</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所有可用 zone 的 xml 配置文件被保存在 /usr/lib/firewalld/zones/ 目录，该目录中的配置为默认配置，不允许管理员手工修改，自定义 zone 配置需保存到 /etc/firewalld/zones/ 目录。防火墙规则即是通过 zone 配置文件进行组织管理，因此 zone 的配置文件功能类似于 /etc/sysconfig/iptables 文件，只不过根据不同的场景默认定义了不同的版本供选择使用，这就是 zone 的方便之处。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="service">service：<a class="hash-link" href="#service" title="标题的直接链接">​</a></h3><p>在 /usr/lib/firewalld/services/ 目录中，还保存了另外一类配置文件，每个文件对应一项具体的网络服务，如 ssh 服务等，与之对应的配置文件中记录了各项服务所使用的 tcp/udp 端口，在最新版本的 firewalld 中默认已经定义了 70+ 种服务供我们使用，当默认提供的服务不够用或者需要自定义某项服务的端口时，我们需要将 service 配置文件放置在 /etc/firewalld/services/ 目录中。service 配置的好处显而易见，第一，通过服务名字来管理规则更加人性化，第二，通过服务来组织端口分组的模式更加高效，如果一个服务使用了若干个网络端口，则服务的配置文件就相当于提供了到这些端口的规则管理的批量操作快捷方式。每加载一项 service 配置就意味着开放了对应的端口访问，使用下面的命令分别列出所有支持的 service 和查看当前 zone 种加载的 service：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --get-services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --list-services</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例">使用示例<a class="hash-link" href="#使用示例" title="标题的直接链接">​</a></h2><p>在 firewalld 官方文档中提供了若干使用示例，这些示例对学习防火墙管理是很好的基本参考资料。接下来我们将通过一些真实的使用示例来展示如何使用 firewalld 对防火墙规则进行管理。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="场景一自定义-ssh-端口号">场景一：自定义 ssh 端口号<a class="hash-link" href="#场景一自定义-ssh-端口号" title="标题的直接链接">​</a></h3><p>出于安全因素我们往往需要对一些关键的网络服务默认端口号进行变更，如 ssh，ssh 的默认端口号是 22，通过查看防火墙规则可以发现默认是开放了 22 端口的访问的：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost ~]# iptables -S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A IN_public_allow -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假设自定义的 ssh 端口号为 22022，使用下面的命令来添加新端口的防火墙规则：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --add-port=22022/tcp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果需要使规则保存到 zone 配置文件，则需要加参数 --permanent。我们还可以使用自定义 service 的方式来实现同样的效果：
在 <code>/etc/firewalld/services/</code> 目录中添加 自定义配置文件 custom-ssh.xml ，内容如下：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token prolog" style="color:#999988;font-style:italic">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">service</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">short</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">customized SSH</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">short</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">description</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Secure Shell (SSH) is a protocol for logging into and executing commands on remote machines. It provides secure encrypted communications. If you plan on accessing your machine remotely via SSH over a firewalled interface, enable this option. You need the openssh-server package installed for this option to be useful.</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">description</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">port</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">protocol</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">tcp</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">port</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">22022</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">service</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行命令重载配置文件，并添加防火墙规则:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl reload firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --add-service=custom-ssh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一旦新的规则生效，旧的 ssh 端口规则旧可以被禁用掉：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --remove-service=ssh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="场景二允许指定的ip访问snmp服务">场景二：允许指定的IP访问SNMP服务<a class="hash-link" href="#场景二允许指定的ip访问snmp服务" title="标题的直接链接">​</a></h3><p>某些特殊的服务我们并不想开放给所有人访问，只需要开放给特定的IP地址即可，例如 SNMP 服务，我们将使用 firewalld 的富语言风格配置指令：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --add-rich-rule=&quot;rule family=&#x27;ipv4&#x27; source address=&#x27;10.0.0.2&#x27; port port=&#x27;161&#x27; protocol=&#x27;udp&#x27; accept&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看防火墙规则状态，证明结果正是我们想要的：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost ~]# iptables -S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A IN_public_allow -s 10.0.0.2/32 -p udp -m udp --dport 161 -m conntrack --ctstate NEW -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参考链接：<sup id="fnref-2-c7e489"><a href="#fn-2-c7e489" class="footnote-ref">2</a></sup></p><div class="footnotes"><hr><ol><li id="fn-1-c7e489"><a href="https://fedoraproject.org/wiki/FirewallD/zh-cn" target="_blank" rel="noopener noreferrer">https://fedoraproject.org/wiki/FirewallD/zh-cn</a><a href="#fnref-1-c7e489" class="footnote-backref">↩</a></li><li id="fn-2-c7e489"><a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html" target="_blank" rel="noopener noreferrer">https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html</a><a href="#fnref-2-c7e489" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/firewalld">firewalld</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2014/10/19/nginx-perf-tun">NGINX性能调优简要</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2014-10-19T00:00:00.000Z" itemprop="datePublished">2014年10月19日</time> · <!-- -->阅读需 13 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>以下是数天前NGINX官方博客发表的一篇有关nginx性能优化的文章，内容简明扼要，值得一读。译文在原文基础上略有变动，如有不足，欢迎指正。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>NGINX作为一款高性能负载均衡器，缓存和web服务器被大家所熟知，为全世界40%的网站提供着服务。NGINX和Linux系统中的大多数默认配置对普通应用来说已经很合适，然而要想达到更高的性能以应对高负载场景那么一些性能优化是必须的。这篇文章将会探讨一些在性能调优时涉及到的NGINX和Linux系统参数。当然可供调节的参数众多，我们这里只会涉及部分对大多数用户来说被使用最多的。其他没有被涉及到的参数多是需要对系统有深入了解之后才需要接触到的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a class="hash-link" href="#简介" title="标题的直接链接">​</a></h2><p>我们假定此文读者对NGINX的基本架构和配置有一定了解，此文不会重复NGINX文档中的内容，如有涉及我们仅会给出链接。</p><p>在做性能调优时一个最佳实践是一次只动一个参数，如果调整后未达到预期效果，则将其修改回初始值。我们将从Linux系统的一些参数开始讲起，这些参数将对后续的NGINX配置调整有着至关重要的作用。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="linux-配置">Linux 配置<a class="hash-link" href="#linux-配置" title="标题的直接链接">​</a></h2><p>现代Linux内核（2.6+）中的很多参数设置都是十分到位的，但是仍然有一些是需要我们进行调整的。如果一些默认的值设置得太小，那么在内核日志中将记录着错误信息，这预示着我们需要对其中一些参数进行调整了。在众多选项当中我们只会涉及到对大多数负载场景都实用的，请参考Linux系统文档以了解更多有关这些选项的细节。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backlog-queue">Backlog Queue<a class="hash-link" href="#backlog-queue" title="标题的直接链接">​</a></h3><p>下面的设置与网络连接和连接队列有直接关联。如果你有大量的接入请求，且偶尔出现一些失效请求的话，那么下面的设置将起到优化效果。</p><p><code>net.core.somaxconn</code></p><p>此参数控制NGINX等待连接的队列大小。因NGINX处理连接的速度快，所以一般这个参数不建议被设置太大，但是默认值有点偏低，所以针对大流量网站来说调整这个参数是必须的，如果此参数被设置多低那么有可能在内核日志中看到报错，这时需要调整此参数直到报错消失为止。注意，如果此参数设置大于512的话，则需要对NGINX配置中的listen指令中的backlog参数进行同步调整。</p><p><code>net.core.netdev_max_backlog</code></p><p>此参数控制数据包在进入CPU处理前，在网卡中被缓存的量，需要处理大带宽的机器需要增加此参数的值。设置此参数需要参考具体的网卡的文档或者根据系统错误日志进行调整。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="file-descriptors">File Descriptors<a class="hash-link" href="#file-descriptors" title="标题的直接链接">​</a></h3><p>文件描述符是系统在处理如网络连接和打开文件时的系统资源。NGINX中每个连接的建立可能需要占用两个文件描述符，例如代理模式下，一个用来处理客户端连接，一个用来处理到后端的连接，而如果HTTP keepalives被启用的话对文件描述符的消耗会轻松一些。需要处理高并发的机器建议调整下面的参数：</p><p><code>sys.fs.file_max</code></p><p>这个参数影响系统全局的文件描述符打开数量限制。</p><p><code>nofile</code></p><p>此参数影响单个用户的文件描述符数量，在/etc/security/limits.conf中进行设置。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ephemeral-ports">Ephemeral ports<a class="hash-link" href="#ephemeral-ports" title="标题的直接链接">​</a></h3><p>当NGINX被作为代理服务器时，每个到后端服务器的连接将占用一个临时的，或短期的端口。</p><p><code>net.ipv4.ip_local_port_range</code></p><p>此参数控制可被用作临时端口的起始范围，一个通用设置是1024-65000</p><p><code>net.ipv4.tcp_fin_timeout</code></p><p>此参数控制一个连接使用完毕后端口被回收再利用的超时时间，一般默认设置为60秒，但是一般设置降低到30或者15秒都是没有问题的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-配置">NGINX 配置<a class="hash-link" href="#nginx-配置" title="标题的直接链接">​</a></h2><p>下面介绍NGINX中对性能有影响的参数，如下面提到的一样，我们只讲解一些适用于大多数用户的参数进行调整，其他未提及的可能是不建议调整的。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="worker-processes">Worker Processes<a class="hash-link" href="#worker-processes" title="标题的直接链接">​</a></h3><p>NGINX可以同时启动多个worker进程，每个进程处理大量的连接，通过调整下面的参数可以控制启动的进程数量和每个进程所处理的连接数量。</p><p><code>worker_processes</code></p><p>此参数控制NGINX启动进程的数量，在多数情况下每个cpu核心分配一个进程是最佳的，将参数值设置为auto即可达到。很多场景下都需要增加此参数的值，如在需要处理大量磁盘I/O的场景。默认的值是1。</p><p><code>worker_connections</code></p><p>此参数控制在同一时刻单个进程可以处理的最大连接数。默认值512，但大多数系统都可以处理更大的量。其最佳值与实际场景和系统有关，需要经过反复测试才能得出。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keepalives">Keepalives<a class="hash-link" href="#keepalives" title="标题的直接链接">​</a></h3><p>Keepalive连接降低连接的建立和关闭对CPU和网络的消耗，对性能有着十分重要的影响。NGINX会关闭所有客户端的连接，且与后端服务器的连接都是独立的。NGINX支持到客户端和后端的keepalive，下面的参数对客户端keepalive进行控制：</p><p><code>keepalive_requests</code></p><p>此参数控制通过单个keepalive连接可以处理的客户端请求数量，默认值是100，可以调整为更大的值，特别是在通过单个客户端进行压力测试的时候。</p><p><code>keepalive_timeout</code></p><p>此参数控制单个keepalive连接在空闲状态保持连接的时间。</p><p>下面的参数对后端keepalive进行控制：</p><p><code>keepalive</code></p><p>此参数控制单个worker进程保持到upstream server的keepalive连接数量，且默认没有设置。如需启动到后端的keepalive连接则需要进行如下设置： </p><p><code>proxy_http_version 1.1;</code>
<code>proxy_set_header Connection &quot;&quot;;</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="access-logging">Access Logging<a class="hash-link" href="#access-logging" title="标题的直接链接">​</a></h3><p>请求产生的日志记录对CPU和I/O都有消耗，一个可以降低资源消耗的办法是启用日志缓存。启用日志缓存后，NGINX将缓存部分请求日志，然后一次性写入文件。要启用日志缓存只需要在access_log中增加“buffer=size”的设置即可，size值控制缓存的大小，同时也可以设置“flush=time”以控制缓存的时间，设置了两个参数后，NGINX会在缓存被充满或者日志条目数达到flush值时回写日志。在worker进程重启或者关闭时也会回写日志。而永久禁用日志记录也是可以实现的。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sendfile">Sendfile<a class="hash-link" href="#sendfile" title="标题的直接链接">​</a></h3><p>Sendfile 是一项操作系统特性，可以被NGINX启用。它通过对数据在文件描述符之间进行in-kernel copying来提供更快的tcp数据传输处理，一般通过zero-copy技术实现。NGINX使用它来完成缓存数据或者磁盘数据到socket的写操作，不产生任何的用户空间上下文切换开销，可降低CPU负载和提高处理速度。当启用sendfile特性之后，由于数据不经过用户空间，使得对数据内容进行处理的filter将不起作用，例如gzip filter将默认被禁用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="limits">Limits<a class="hash-link" href="#limits" title="标题的直接链接">​</a></h3><p>NGINX也为用户提供设置连接限制的能力，用来对客户请求的资源进行控制，对系统性能，用户体验和安全性也产生极大的影响。下面是部分用于请求限制的指令：</p><p><code>limit_conn/limit_conn_zone</code></p><p>这两个指令用来控制NGINX可接收的连接数，例如来自单个客户端IP的连接请求。这有助于限制客户端建立过多的连接并消耗过多资源。</p><p><code>limit_rate</code></p><p>这个指令控制单个连接允许的客户端最大带宽。这可以避免系统被部分客户端耗尽资源，保证了为每个客户端请求提供服务的质量。</p><p><code>limit_req/limit_req_zone</code></p><p>这两个指令可以控制NGINX的请求回复水平，以不至于被部分客户端拖垮。也被用来加强安全性，特别是对登陆页面等进行有效的保护。</p><p><code>max_conns</code></p><p>这个指令用来控制到后端服务器的最大连接数，保护后端服务器不被拖垮，默认值是zero，没有任何限制。</p><p><code>queue</code></p><p>如果max_conns被设置，那么此参数对超过最大连接时的状态产生影响，可以设置队列中请求的个数和缓冲时间，如果没有设置此参数，则队列不存在。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他设置">其他设置<a class="hash-link" href="#其他设置" title="标题的直接链接">​</a></h2><p>NGINX还有一些特性能对某些特定场景下的应用起到性能优化作用，我们将探讨其中的两个特性。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="缓存">缓存<a class="hash-link" href="#缓存" title="标题的直接链接">​</a></h3><p>当把NGINX作为负载均衡器来使用的场景下，启用cache可以显著改善到客户端的响应时间，且显著降低后端服务器的压力。如需了解更多NGINX的caching设置，可以参考此链接：: NGINX Admin Guide – Caching.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="压缩">压缩<a class="hash-link" href="#压缩" title="标题的直接链接">​</a></h3><p>对回应内容进行压缩将有效降低回应内容的大小，降低带宽消耗，然而压缩将增加CPU的开销，所以带宽成本较高时启用才是明智之举。需要明确注意的是不要对已经压缩的内容启用压缩，例如jpeg格式的图片，如需了解更多有关压缩的设置可以参考此文档： NGINX Admin Guide – Compression and Decompression</p><p>原文链接:</p><p><a href="http://nginx.com/blog/tuning-nginx/" target="_blank" rel="noopener noreferrer">http://nginx.com/blog/tuning-nginx/</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/nginx">nginx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/performance">performance</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2014/05/23/bash-shell-coding-style">shell脚本coding style总结</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2014-05-23T00:00:00.000Z" itemprop="datePublished">2014年5月23日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>这里总结了个人比较推崇的shell脚本coding style，编写出方便阅读和维护的脚本是运维人员的基本操守。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>1.关于缩进： 一个tab定义为4个空格；
关于这个缩进距离貌似有太多的的说法了，有的会用8个空格，有的用2个空格，还有的用4个空格；不过最终取决于团队风格。但是记住，正确的做法是项目、文件、成员间全部统一，千万不要出现一个项目内各种缩进，tab和空格混用，甚至一个文件中的缩进都不统一的情况。在vim中设置如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set ts=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set sw=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set expandtab</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2.尽量缩短单行的长度，最好不超过72字符（注意：这个限制因历史原因导致，为了兼容那些老的终端设备而考虑，实际上现在已经不适用了，单行代码可以更长，只要不要超过大多数屏幕的输出宽度就好）</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thisisaverylongline || thisisanotherlongline</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thisisaverylongline ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    thisisanotherlongline</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3.注释尽量保持清晰的层次,#号与注释文本间保持一个空格以示和代码的区分</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#this is a comment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#this is a code line</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># this is a comment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#this is code line</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4.定义函数可以不用写function关键字，函数名字尽量短小无歧义，尽量传递返回值</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function  cmd1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmd_start() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   dosomethinghere</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5.全局变量用大写，局部变量用小写，函数内尽量不要使用全局变量，以免混淆导致变量覆盖,注意尽量使用小写表示变量</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">foo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo $a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $a</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">foo(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo $a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6.使用内建的[] 、[[]] 进行条件测试，避免使用test命令</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test -f filename</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[ -f filename ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[ -n $string ]]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>7.使用$(())进行普通运算，尽量避免使用expr或其他外部命令 $[]也可用于计算</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">num=$(expr 1 + 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">num=$((1+1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num=$[1+2]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>8.管道符左右都应加空格，重定向符空格加左不加右</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">find /data -name tmp*|xargs rm -fr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat a&gt;b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">find /data -name tmp* | xargs rm -fr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat a &gt;b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>9.当<code>source</code>命令属于外部命令的时候，我们应尽量使用<code>.</code>   ，当视力不好怕写错看错的时候，应尽量不用<code>.</code>而用<code>source</code>，在实际使用中我们发现<code>.</code>号极难辨认，这里推荐使用source命令，更方便维护。</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">. func_file</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source func_file</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>10.if 和 then 之间使用分号+空格分隔，不要用换行，书写上和c style类似：</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">grep string logfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ $? -ne 0 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dosomething</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do something here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if grep string logfile; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dosomething</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while 1; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   do something here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意;和then间有一个空格的距离</p><p>11.如果grep能直接处理文件输入那就不要和cat连用; 如果wc能直接从文件统计就不要和cat连用; 如果grep能统计行数就不要和wc连用</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat file | grep tring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat file.list | wc -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep avi av.list | wc -l</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">grep tring file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wc -l file.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep -c avi av.list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>12.如果awk的时候需要搜索恰好awk又能搜索，那么就不要再和grep连用</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dosomething | grep tring | awk &#x27;{print $1}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dosomething | awk &#x27;/tring/&#x27; &#x27;{print $1}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>13、尽量编写兼容旧版本shell风格且含义清晰的代码，不推荐不兼容写法或者不方便他人维护的代码</p><p>bad:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">do_some_thing |&amp; do_another_thing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do_some_thing &amp;&gt;&gt; some_where</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>good:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">do_some_thing 2&gt;&amp;1 | do_another_thing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do_some_thing &gt;some_where 2&gt;&amp;1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>注意</em></strong> : 以上仅代表个人习惯和理解，并不能适用于所有人，适合的才是最好的。</p><p>拓展阅读文档：</p><ul><li><a href="http://kodango.me/simple-bash-programming-skills" target="_blank" rel="noopener noreferrer">http://kodango.me/simple-bash-programming-skills</a></li><li><a href="http://kodango.me/simple-bash-programming-skills-2" target="_blank" rel="noopener noreferrer">http://kodango.me/simple-bash-programming-skills-2</a></li><li><a href="http://www.commandlinefu.com/commands/browse" target="_blank" rel="noopener noreferrer">http://www.commandlinefu.com/commands/browse</a></li><li><a href="http://wiki.bash-hackers.org/scripting/style" target="_blank" rel="noopener noreferrer">http://wiki.bash-hackers.org/scripting/style</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/coding-style">coding_style</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2014/04/08/systemd-basic-usage">Systemd基本使用介绍</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2014-04-08T00:00:00.000Z" itemprop="datePublished">2014年4月8日</time> · <!-- -->阅读需 15 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>但是由于计算机软硬件的不断发展，人们逐渐发现sysvinit所提供的功能已经无法满足当前的需求，服务多年的sysvinit终将过时，于是一些替代的方案开始出现，这其中包括upstart ，systemd等。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于pid-1">关于PID 1<a class="hash-link" href="#关于pid-1" title="标题的直接链接">​</a></h2><p>在linux的世界里，第一个启动到用户空间的进程名叫init，其pid为1，init进程启动完毕后，它相当于其他进程的根，负责将其他的服务进程启动起来，最终启动成为一个完整可用的系统。而提供这个init程序的软件名为sysvinit，它在整个linux系统中所担任的角色重要程度无可厚非。但是由于计算机软硬件的不断发展，人们逐渐发现sysvinit所提供的功能已经无法满足当前的需求，服务多年的sysvinit终将过时，于是一些替代的方案开始出现，这其中包括upstart ，systemd等。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="init的责任">init的责任<a class="hash-link" href="#init的责任" title="标题的直接链接">​</a></h2><p>为什么说sysvinit会过时呢？我们从用户需求的角度来看不难发现，其实我们对init的最原始最核心需求是，将系统从内核引导至用户空间，而由于现在硬件水平的发展，使得我们在单纯的原始需求之上产生了新的或者更多的需求，那就是不仅要引导系统，而且要快速的引导系统。而早在sysvinit诞生的那个时候启动速度的重要程度似乎不是很高，所以它在这方面显得有些老是很自然的。现在让我们继续思考一下如何才能实现快速引导。试想，当一个系统启动的时候需要启动长长的一列服务，这样的系统启动速度应该不会快到哪里去，如大多数人使用桌面系统的情况一样，一个加快系统启动速度的最直接方法就是减少启动项，把不必要的启动项禁止掉。而另外一个方法则实现起来不像第一个这么简单，那就是并行启动。并行启动可以带来的速度提升显而易见，我们只需要尽可能保证让更多的服务可以并行启动即可。而从其他方面来看sysvinit由于对脚本的依赖导致启动完毕所有服务过程中需要大量的执行外部命令，这一点也将导致引导速度的变慢。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="后起之秀">后起之秀<a class="hash-link" href="#后起之秀" title="标题的直接链接">​</a></h2><p>当一项标准已经无法满足当下发展的需求时，最好的办法是打破陈规让自己变成新的标准。systemd就是这么做的，因为现实的需要它已经不能顾及POSIX标准了，以不至于阻碍其更好的发展，而systemd在设计之初也和苹果的launchd在某些地方不谋而合。尽管在最初的时候这种做法没有得到所有人的认可甚至是惹恼了一些家伙，但是现在看来systemd已经成为了事实上的标准了，现在已经采用systemd的发行版有fedora，opensuse，debian，ubuntu，rhel7，archlinux等，尽管在systemd的推广过程中发生了很多曲折，但最终大家的选择是一致的---朝着更好的方向发展而不是墨守陈规。
在功能上，systemd不仅仅是解决了现有程序的种种问题，而且包含了大量新的特性，这意味着系统中原本需要的很多组件现在也都可以下岗了，下面来看看systemd的一些特性：</p><ul><li>服务管理 - 提供了统一的启动/停止/重启/重载 而不再需要编写一大坨脚本来干这种原本就应该十分简单基本且重要的事情，取而代之的是更为简洁的配置文件，这也表示今后的系统中各种service启动控制的统一性，使得daemon服务开发者免于编写各种看上去参差不齐的启动脚本，增加了通用性。</li><li>socket管理 - 支持监听socket，这使得socket的监听和服务本身可以相互独立，一方面可以以此提高服务启动速度，另外一方面还可以节约系统开销。</li><li>设备管理 - 可以配合udev规则对设备进行管理，还可以配合/etc/fstab文件实现磁盘的挂载管理，甚至实现更高级的自动挂载；</li><li>target分组 - 把不同的unit组合起来，组合到同一个target里面，完全取代sysvinit的运行等级的概念；</li><li>状态快照 - 可以对当前系统中的unit状态进行快照，这个概念有些类似于系统的休眠与恢复，你可以让系统从一个状态切换进入另外一个状态；</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="systemd管理入门">systemd管理入门<a class="hash-link" href="#systemd管理入门" title="标题的直接链接">​</a></h2><p>下面我们将通过一些例子来演示一些基本的管理命令，这些命令对于系统管理员来说至关重要。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1--如何检查启动项">1  如何检查启动项<a class="hash-link" href="#1--如何检查启动项" title="标题的直接链接">​</a></h3><p>任何启动项，只要是在系统启动时有被执行到，不论启动成功还是失败，systemd都能够记录下他们的状态，直接执行不带参数的systemctl命令即可观察到，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># systemctl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UNIT                                             LOAD   ACTIVE SUB       DESCRIPTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proc-sys-fs-binfmt_misc.automount                loaded active waiting   Arbitrary Executable File Formats File System Aut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.0-backlight-acpi_video1.device loaded active plugged   /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.0-backlight-acpi_video0.device loaded active plugged   /sys/devices/pci0000:00/0000:00:02.0/backlight/ac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.00-0000:00:19.0-net-em1.device loaded active plugged   82579LM Gigabit Network Connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.d1.4:1.0-bluetooth-hci0.device loaded active plugged   /sys/devices/pci0000:00/0000:00:1a.0/usb1/1-1/1-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.000:00:1b.0-sound-card0.device loaded active plugged   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> Series/C200 Series Chipset Family High Definiti</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.0000:03:00.0-net-wlp3s0.device loaded active plugged   RTL8188CE </span><span class="token number" style="color:#36acaa">802</span><span class="token plain">.11b/g/n WiFi Adapter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-0:0:0:0-block-sda-sda1.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-0:0:0:0-block-sda-sda2.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-0:0:0:0-block-sda-sda3.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-0:0:0:0-block-sda-sda5.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-0:0:0:0-block-sda-sda6.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-0:0:0:0-block-sda-sda7.device loaded active plugged   LVM PV EKHM59-PY9G-AoRX-Nr9k-nnxN-XxxO-DFcj4N on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.0:0:0-0:0:0:0-block-sda.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-1:0:0:0-block-sdb-sdb1.device loaded active plugged   KINGSTON_SVP200S360G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.-1:0:0:0-block-sdb-sdb2.device loaded active plugged   LVM PV rlRqSb-IlQn-DJQi-i7fg-sUV5-3bjI-g2npg7 on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.1:0:0-1:0:0:0-block-sdb.device loaded active plugged   KINGSTON_SVP200S360G</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要检查具体的服务，则使用status选项加上服务名即可，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># systemctl status libvirtd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libvirtd.service - Virtualization daemon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/usr/lib/systemd/system/libvirtd.service</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> since 一 </span><span class="token number" style="color:#36acaa">2014</span><span class="token plain">-04-07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:30 CST</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 9min ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Docs: man:libvirtd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           http://libvirt.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Main PID: </span><span class="token number" style="color:#36acaa">1673</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libvirtd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   CGroup: /system.slice/libvirtd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ├─1673 /usr/sbin/libvirtd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           └─1804 /sbin/dnsmasq --conf-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/libvirt/dnsmasq/default.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">月 07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:33 localhost.localdomain dnsmasq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1804</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: using nameserver </span><span class="token number" style="color:#36acaa">218.6</span><span class="token plain">.200.139</span><span class="token comment" style="color:#999988;font-style:italic">#53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">月 07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:33 localhost.localdomain dnsmasq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1804</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: using nameserver </span><span class="token number" style="color:#36acaa">61.139</span><span class="token plain">.2.69</span><span class="token comment" style="color:#999988;font-style:italic">#53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">月 07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:33 localhost.localdomain dnsmasq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1804</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: using </span><span class="token builtin class-name">local</span><span class="token plain"> addresses only </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> unqualified names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">月 07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:33 localhost.localdomain dnsmasq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1804</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">read</span><span class="token plain"> /etc/hosts - </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">月 07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:33 localhost.localdomain dnsmasq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1804</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">read</span><span class="token plain"> /var/lib/libvirt/dnsmasq/default.addnhosts - </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">月 07 </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:10:33 localhost.localdomain dnsmasq-dhcp</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1804</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">read</span><span class="token plain"> /var/lib/libvirt/dnsmasq/default.hostsfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hint: Some lines were ellipsized, use -l to show </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> full.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上这些信息向我们展示了服务的运行时间，当前状态，相关进程pid，以及最近的有关该服务的日志信息，是不是很方便？</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-找出每项服务所对应的进程id">2 找出每项服务所对应的进程id<a class="hash-link" href="#2-找出每项服务所对应的进程id" title="标题的直接链接">​</a></h3><p>对于系统管理来说这是最常见的工作，但是在sysvinit时代我们只能借助例如ps命令等来完成，而systemd已经考虑到了系统管理员的需求，于是下面的命令诞生了：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># systemd-cgls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─1 /usr/lib/systemd/systemd --switched-root --system --deserialize </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─user.slice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ├─user-1000.slice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ ├─session-1.scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1806 gdm-session-worker </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pam/gdm-password</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1820 /usr/bin/gnome-keyring-daemon --daemonize --login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1822 gnome-session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1830 dbus-launch --sh-syntax --exit-with-session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1831 /bin/dbus-daemon --fork --print-pid </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> --print-address </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> --session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1858 /usr/libexec/at-spi-bus-launcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1862 /bin/dbus-daemon --config-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/at-spi2/accessibility.conf --nofork --print-address </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1865 /usr/libexec/at-spi2-registryd --use-gnome-session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1872 /usr/libexec/gvfsd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在我们可以很清晰的看到哪项服务启动了哪些进程，对于系统管理来说十分有用；</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-如何正确的杀死服务进程">3 如何正确的杀死服务进程<a class="hash-link" href="#3-如何正确的杀死服务进程" title="标题的直接链接">​</a></h3><p>在sysvinit的时代，如果需要结束一个服务及其启动的所有进程，可能会遇到一些糟糕的进程无法正确结束掉，即便是我们使用kill，killall等命令来结束它们，到了systemd的时代一切都变得不一样，systemd号称是第一个能正确的终结一项服务的程序，下面来看看具体如何操作的：</p><p><code>systemctl kill crond.service</code></p><p>或者指定一个信号发送出去</p><p><code>systemctl kill -s SIGKILL crond.service</code></p><p>例如可以像这样执行一次reload操作</p><p><code>systemctl kill -s HUP --kill-who=main crond.service</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-如何停止和禁用一项服务">4 如何停止和禁用一项服务<a class="hash-link" href="#4-如何停止和禁用一项服务" title="标题的直接链接">​</a></h3><p>下面我们回顾一下在sysvinit时代执行下面的命令所实现的功能</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># service ntpd stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># chkconfig ntpd off</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>很简单，首先停止服务，其次禁用服务
那么在systemd中应该如何操作呢？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemctl stop ntpd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># systemdctl disable ntpd.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>很显然systemctl命令已经取代了service 和chkconfig两个命令的位置，不光如此，我们还能将服务设置为连人工也无法启动：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ln -s /dev/null  /etc/systemd/system/ntpd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># systemctl daemon-reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-检查系统启动消耗时间">5 检查系统启动消耗时间<a class="hash-link" href="#5-检查系统启动消耗时间" title="标题的直接链接">​</a></h3><p>在过去我们可以借助第三方工具来实现对系统启动过程的耗时跟踪，现在这个功能已经集成到systemd当中，可以十分方便的了解到系统启动时在各个阶段所花费的时间：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># systemd-analyze</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Startup finished </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.669s </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kernel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.514s </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initrd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.106s </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userspace</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">.290s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">以上信息简要的列出了从内核到用户空间整个引导过程大致花费的时间，如果要查看具体每项服务所花费的时间则使用如下命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># systemd-analyze blame</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">.468s dnf-makecache.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.556s network.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.022s plymouth-start.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           812ms plymouth-quit-wait.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           542ms lvm2-pvscan@8:7.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           451ms systemd-udev-settle.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           306ms firewalld.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           246ms dmraid-activation.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           194ms lvm2-pvscan@8:18.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           171ms lvm2-monitor.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           145ms bluetooth.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           135ms accounts-daemon.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           113ms rtkit-daemon.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           111ms ModemManager.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           104ms avahi-daemon.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           102ms systemd-logind.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            79ms systemd-vconsole-setup.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            77ms acpid.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>输出结果类似上面这些内容，至此我们可以看到系统里每一项服务的启动时间，据此可以对系统引导过程了如指掌，如果你觉得这还不够直观，那么可以将结果导出到图像文件里面：</p><p><code>systemd-analyze plot &gt;systemd.svg</code></p><p>该命令会将系统的启动过程输出到一张svg图像上面，更直观的展现出各个服务启动所花费的时间，在我们需要分析和优化服务启动项的时候很有帮助。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-查看各项服务的资源使用情况">6 查看各项服务的资源使用情况<a class="hash-link" href="#6-查看各项服务的资源使用情况" title="标题的直接链接">​</a></h3><p>和top命令不一样，top命令更侧重于展示以进程为单位的资源状态，而systemd提供了一个命令来方便的查看每项服务的实时资源消耗状态：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># systemd-cgtop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path                                              Tasks   %CPU   Memory  Input/s Output/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/                                                   </span><span class="token number" style="color:#36acaa">199</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">12.3</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.9G        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/ModemManager.service                    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/abrt-oops.service                       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/abrt-xorg.service                       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/abrtd.service                           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/accounts-daemon.service                 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/acpid.service                           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/alsa-state.service                      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/atd.service                             </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/auditd.service                          </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/avahi-daemon.service                    </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/bluetooth.service                       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/chronyd.service                         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/colord.service                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/crond.service                           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      -        -        -        -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-我们必须要注意到的配置文件变更">7 我们必须要注意到的配置文件变更<a class="hash-link" href="#7-我们必须要注意到的配置文件变更" title="标题的直接链接">​</a></h3><p>systemd考虑到各种发行版本的用户使用习惯，尽量提供更为通用的配置文件以方便各家统一，方便用户使用，下面列出一些基本的统一的配置文件：</p><ul><li>/etc/hostname，debian和redhat在这个配置文件上的差异导致了系统管理或多或少的不便，此文件的统一意义重大</li><li>/etc/vconsole.conf，此文件用来统一管理console和键盘映射</li><li>/etc/locale.conf 配置系统环境语系</li><li>/etc/modules-load.d/*.conf 内核模块加载配置文件</li><li>/etc/sysctl.d/*.conf 内核参数配置文件，对/etc/sysctl.conf的扩充</li><li>/etc/tmpfiles.d/*.conf 运行态临时文件配置</li><li>/etc/os-release  /etc/machine-id  /etc/machine-info 这三个文件的统一对系统管理员来说也是意义深远，它让我们有了统一的检测发行版本等信息的入口</li></ul><p>以上内容仅仅让各位对systemd形成基本的认识，我们将在后期的文章中更加深入地讨论systemd的特性。最后，再次感谢作者Lennart的贡献。</p><blockquote><p>参考链接：</p><ul><li><a href="http://cgit.freedesktop.org/systemd/" target="_blank" rel="noopener noreferrer">http://cgit.freedesktop.org/systemd/</a></li><li><a href="http://0pointer.de/blog/projects/" target="_blank" rel="noopener noreferrer">http://0pointer.de/blog/projects/</a></li><li><a href="https://linuxtoy.org/archives/interview-creater-of-systemd-and-pulseaudio-lennart.html" target="_blank" rel="noopener noreferrer">https://linuxtoy.org/archives/interview-creater-of-systemd-and-pulseaudio-lennart.html</a></li></ul></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/systemd">systemd</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2013/11/12/use-fpm2-to-manage-password">使用fpm2来管理ssh密码</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-11-12T00:00:00.000Z" itemprop="datePublished">2013年11月12日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>不知道有没有童鞋需要管理一堆ssh口令，5个以内靠脑子记可能是个好办法，但是如果10个100个的时候恐怕脑子记有点不太够用。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>不知道有没有童鞋需要管理一堆ssh口令，5个以内靠脑子记可能是个好办法，但是如果10个100个的时候恐怕脑子记有点不太够用，
这个时候就需要借助外部工具来进行管理，当然你可以自己写个简单的脚本，把ssh账号密码写入一个list里面，
人懒且为了省事也可以使用一些现成的工具，下面就推荐一个图形界面的小工具给需要的童鞋：fpm2
fpm2全名Figaro&#x27;s Paaword Manager 2，是一个开源软件，使用GNU General Public License Version 2 协议，这里是<a href="http://als.regnet.cz/fpm2/" target="_blank" rel="noopener noreferrer">官方地址</a>，它还有android版本的。</p><p>在fedora里面可以直接yum安装：</p><p><code>yum install fpm2</code></p><p>安装完成后第一次运行需要你输入一个密码，今后每次启动fpm2的时候就用这个密码，默认如果密码输入错误次数超过3次，则你懂的。</p><p>打开fpm2后，一看就明白如何使用，它支持ssh/web以及自定义的密码管理，可以对管理的服务器进行分类，十分方便。其亮点是你可以根据自己的需要设置launcher，默认双击建立好的口令就会自动执行launcher定义的命令；</p><p>launcher里面将保存的账号密码和IP/URL定义为参数，<code>$a ip/url</code>  ，<code>$u  username</code>  ， <code>$p  password</code>， 有了这些变量后自定义launcher就很方便了。</p><p>但是其默认的ssh的launcher是不支持直接双击list里面的项目就登陆进服务器的，这个时候需要另外一个小工具sshpass，它的用处是登陆ssh的时候可以把密码作为参数传递给ssh客户端，而不需要交互式输入密码，这个工具代码托管在sf，fedora里也可以yum安装：</p><p><code>yum install sshpass</code></p><p>光有这两个工具还不够，下面是将两个工具完美结合起来的关键：</p><p>在fpm2的settings选项卡下有launcher设置项，打开之后你会发现默认的ssh launcher，下面是我自定义的ssh的加载器命令：</p><p>配置launcher</p><p><code>gnome-terminal -e &#x27;sh -c &quot;&#x27;&quot;sshpass -p &#x27;&quot;&#x27;$p&#x27;&quot;&#x27; ssh  -p 22 $u@$a;sudo -s&quot;&#x27;&quot;&#x27;</code></p><p>特别注意里面的单双引号的写法，不然如果你的密码里有像%&amp;$之类的特殊符号时是会出问题的，</p><p><code>gnome-terminal -e &#x27;xxxxx&#x27;</code> 这里是单引号</p><p><code>sh -c &quot;&#x27;&quot; xxxxx &quot;&#x27;&quot;</code> 这里是两对双引号中包含的单引号</p><p><code>sshpass -p &#x27;&quot;&#x27; xxx &#x27;&quot;&#x27;</code> 这里是两对单引号包含的双引号</p><p>ssh命令后面加个sudo -s的作用是当退出ssh连接时不会立即关闭当前的terminal终端</p><p>使用这个launcher可以通杀所有特殊字符的密码，在运行fpm2+sshpass的组合前请自己使用当前运行fpm2的账户登陆ssh一下远程服务器将服务器的publickey取回来，没有key的情况下sshpass无法工作的。至少我遇到的是这样。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/fpm-2">fpm2</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2013/11/11/centos-multi-network-interface-route">CentOS中双网卡静态路由配置</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-11-11T00:00:00.000Z" itemprop="datePublished">2013年11月11日</time> · <!-- -->阅读需 4 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p> 一个网卡的话不需要静态路由的，如果多个网卡的话可以手工配置静态路由，特别是多个网卡走不同的子网的时候。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="来自网上搜索的方法">来自网上搜索的方法<a class="hash-link" href="#来自网上搜索的方法" title="标题的直接链接">​</a></h2><p>之前一直没有配置过两个网卡分别使用不同的IP，走不同的网关，google了下发现了下面的手工添加路由的脚本：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.1</span><span class="token plain">.1.0/24 dev br0 src </span><span class="token number" style="color:#36acaa">10.1</span><span class="token plain">.1.10 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> default via </span><span class="token number" style="color:#36acaa">10.1</span><span class="token plain">.1.1 dev br0 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> rule </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> from </span><span class="token number" style="color:#36acaa">10.1</span><span class="token plain">.1.10/32 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> rule </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">10.1</span><span class="token plain">.1.10/32 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.1.0/24 dev br1 src </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.1.10 table bond1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> default via </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.1.1 dev br1 table bond1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> rule </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> from </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.1.10/32 table bond1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> rule </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.1.10/32 table bond1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="来自红帽文档中的方法">来自红帽文档中的方法<a class="hash-link" href="#来自红帽文档中的方法" title="标题的直接链接">​</a></h2><p>后来想了想这样的问题系统肯定已经支持得很好了，只是没有找到配置方法，于是找了下红帽的文档，发现可以像下面这样配置：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置静态路由">配置静态路由<a class="hash-link" href="#配置静态路由" title="标题的直接链接">​</a></h3><p> 一个网卡的话不需要静态路由的，如果多个网卡的话可以手工配置静态路由，特别是多个网卡走不同的子网的时候。</p><p><code>route -n   #查看当前路由信息</code></p><p>静态路由配置文件路径:
<code>/etc/sysconfig/network-scripts/route-interface_name</code>
就和网卡的配置文件路径结构差不多，比如ifcfg-eth0变成了route-eth0。</p><p>eth0网卡的静态路由就保存在这个文件里面。这个文件可以有两种格式</p><ul><li>IP命令参数格式</li><li>网络/掩码指令格式</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ip命令参数模式">IP命令参数模式：<a class="hash-link" href="#ip命令参数模式" title="标题的直接链接">​</a></h4><p>1）第一行定义默认路由：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default via X.X.X.X dev interface</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>X.X.X.X 是默认路由的IP. interface是可以连接到默认路由的网卡接口名.</p><p>2）静态路由一行一个：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">X.X.X.X/X via X.X.X.X dev interface</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>X.X.X.X/X 是网络和掩码. X.X.X.X 和 interface 是各自网段的网关IP和网卡接口.</p><p>配置示例 route-eth0：
默认网关 192.168.0.1, 接口eth0. 两条静态路由到 10.10.10.0/24 和172.16.1.0/24 :</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default via 192.168.0.1 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.10.10.0/24 via 10.10.10.1 dev eth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.16.1.0/24 via 192.168.0.1 dev eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="网络掩码指令格式">网络/掩码指令格式：<a class="hash-link" href="#网络掩码指令格式" title="标题的直接链接">​</a></h4><p>route-interface文件的第二种格式.下面是样板:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ADDRESS0=X.X.X.X</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK0=X.X.X.X</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY0=X.X.X.X</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ADDRESS0=X.X.X.X 静态路由的网络编号.
NETMASK0=X.X.X.X 为上面那行设置子网掩码 .
GATEWAY0=X.X.X.X  能够连接到 ADDRESS0=X.X.X.X 这个网络的网关</p><p>配置示例 route-eth0：
默认网关 192.168.0.1, 接口 eth0. 两条到10.10.10.0/24 和172.16.1.0/24 的静态路由：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ADDRESS0=10.10.10.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK0=255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY0=10.10.10.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADDRESS1=172.16.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK1=255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY1=192.168.0.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ADDRESS0, ADDRESS1, ADDRESS2, 这样的编号必须是一个接一个的数字。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/centos">centos</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/route">route</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/blog/page/2"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/blog/page/4"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/notes/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 老司机. Built with Docusaurus.</div></div></div></footer></div>
<script src="/notes/assets/js/runtime~main.19061fe9.js"></script>
<script src="/notes/assets/js/main.7e231f6a.js"></script>
</body>
</html>